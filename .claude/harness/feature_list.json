{
  "$schema": "domain-memory-harness-v2",
  "schema_version": "2.0",
  "description": "Backlog for LightwaveOS ESP32-S3 LED control system. Each item is derived from existing project state, not invented.",
  "items": [
    {
      "id": "FIX-TEST-ASSERTIONS",
      "title": "Fix test assertions for current hardware",
      "description": "The existing test file (test/test_main.cpp) asserts NUM_LEDS=81 and palette count=33, but current config uses dual 160-LED strips (320 total). Tests will fail if run. Update test assertions to match current hardware configuration.",
      "acceptance_criteria": [
        "test_led_array_size passes with NUM_LEDS=320",
        "test_palette_count reflects actual palette count",
        "pio test -e native compiles (if applicable) or test file is updated"
      ],
      "verification": [
        "grep -n NUM_LEDS src/config/hardware_config.h",
        "cat test/test_main.cpp"
      ],
      "status": "PASSING",
      "priority": 2,
      "dependencies": [],
      "attempts": [
        {
          "run_id": "worker-004",
          "timestamp": "2025-12-12T08:30:00Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "grep NUM_LEDS",
              "cat test/test_main.cpp",
              "pio run -e esp32dev"
            ],
            "results_summary": "Changed LED assertion from 81 to 320. Palette count (33) was already correct. Build passes."
          },
          "commit": "c68b6a4",
          "reverted": false
        }
      ],
      "override_reason": null,
      "notes": "Fixed: LED count assertion changed 81→320. Palette count was already correct at 33."
    },
    {
      "id": "VERIFY-WIFI-BUILD",
      "title": "Verify WiFi build compiles successfully",
      "description": "The WiFi-enabled environment (esp32dev_wifi) is the primary build for web interface testing per CLAUDE.md. Confirm it builds without errors.",
      "acceptance_criteria": [
        "pio run -e esp32dev_wifi completes with SUCCESS",
        "No compilation errors",
        "Binary size is reasonable (< 80% flash)"
      ],
      "verification": [
        "pio run -e esp32dev_wifi"
      ],
      "status": "PASSING",
      "priority": 1,
      "dependencies": [],
      "attempts": [
        {
          "run_id": "worker-002",
          "timestamp": "2025-12-12T06:45:00Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "pio run -e esp32dev_wifi"
            ],
            "results_summary": "SUCCESS - RAM 19.3%, Flash 31.3% (well under 80% limit). Only deprecation warnings (ArduinoJson API changes), no errors."
          },
          "commit": "53de8f1",
          "reverted": false
        }
      ],
      "override_reason": null,
      "notes": "Verified in WORKER run 002. Build takes ~60s cold, ~3s incremental."
    },
    {
      "id": "DOC-BUILD-VERIFICATION",
      "title": "Document canonical verification sequence",
      "description": "Create init.sh that runs the project's fast verification. Currently no single command runs all checks. Need to identify: format, lint, build, test.",
      "acceptance_criteria": [
        "init.sh exists and is executable",
        "Running ./init.sh returns 0 on healthy repo",
        "Script prints clear pass/fail status"
      ],
      "verification": [
        "./init.sh"
      ],
      "status": "PASSING",
      "priority": 1,
      "dependencies": [],
      "attempts": [
        {
          "run_id": "init-001",
          "timestamp": "2025-12-12T06:38:00Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "./init.sh"
            ],
            "results_summary": "init.sh created, executable, returns 0, prints PASS/FAIL summary with colors"
          },
          "commit": "4860021",
          "reverted": false
        }
      ],
      "override_reason": null,
      "notes": "Created in INITIALIZER run 001. Checks: toolchain detection, git status, esp32dev build."
    },
    {
      "id": "CENTER-ORIGIN-AUDIT",
      "title": "Audit effects for CENTER ORIGIN compliance",
      "description": "Per CLAUDE.md, ALL effects must originate from LED 79/80 (center). TODO.md mentions 'Fix center-origin compliance in some LGP effects'. Need to identify and fix non-compliant effects.",
      "acceptance_criteria": [
        "All effects in src/effects/strip/ verified for center-origin pattern",
        "Non-compliant effects identified and listed",
        "At least one non-compliant effect fixed as proof of concept"
      ],
      "verification": [
        "grep -rn 'for.*i = 0' src/effects/strip/ | head -20",
        "grep -rn 'center\\|CENTER\\|79\\|80' src/effects/strip/"
      ],
      "status": "PASSING",
      "priority": 3,
      "dependencies": [],
      "attempts": [
        {
          "run_id": "worker-006",
          "timestamp": "2025-12-12T08:25:00Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "grep -rn 'for.*i = 0' src/effects/strip/*.cpp",
              "grep -rn 'distFromCenter|CENTER_POINT' src/effects/strip/*.cpp"
            ],
            "results_summary": "Audited all effect files. Found 1 non-compliant effect (plasma() in StripEffects.cpp) - was using linear position instead of distFromCenter. Fixed by converting to center-origin pattern. All other effects already compliant."
          },
          "commit": "2c31cdd",
          "reverted": false
        }
      ],
      "override_reason": null,
      "notes": "Fixed: plasma() effect converted to CENTER ORIGIN. All effects now use distFromCenter pattern."
    },
    {
      "id": "HEAP-FRAG-MONITOR",
      "title": "Implement heap fragmentation monitoring",
      "description": "TODO.md lists 'Heap fragmentation monitoring improvements' as known issue. FEATURE_MEMORY_DEBUG is enabled. Need to verify monitoring works or improve it.",
      "acceptance_criteria": [
        "Serial output shows heap stats during operation",
        "Fragmentation percentage is logged",
        "Alert threshold for high fragmentation exists"
      ],
      "verification": [
        "grep -rn 'heap\\|fragment' src/"
      ],
      "status": "PASSING",
      "priority": 4,
      "dependencies": [
        "VERIFY-WIFI-BUILD"
      ],
      "attempts": [
        {
          "run_id": "worker-006",
          "timestamp": "2025-12-12T08:30:00Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "grep -rn 'heap|fragment' src/",
              "pio run -e esp32dev"
            ],
            "results_summary": "Heap monitoring already existed in PerformanceMonitor.h. Enhanced with: (1) Added fragmentation to printCompactStatus(), (2) Added FRAGMENTATION_WARNING_THRESHOLD (30%) and FRAGMENTATION_CRITICAL_THRESHOLD (50%), (3) Added [WARN]/[CRITICAL] alerts, (4) Added isFragmentationWarning()/isFragmentationCritical() query methods."
          },
          "commit": "2c31cdd",
          "reverted": false
        }
      ],
      "override_reason": null,
      "notes": "Enhanced PerformanceMonitor with fragmentation thresholds and alerts."
    },
    {
      "id": "CLEAN-GIT-STATE",
      "title": "Clean up uncommitted changes on feature branch",
      "description": "Git status shows many modified and deleted files on feature/zone-composer branch. The branch has uncommitted work including deleted LightwaveOS-Production directory. Need to commit or stash before harness work.",
      "acceptance_criteria": [
        "git status shows clean working tree (or intentional ignored files only)",
        "Feature branch changes are committed with descriptive message"
      ],
      "verification": [
        "git status --porcelain | wc -l"
      ],
      "status": "PASSING",
      "priority": 2,
      "dependencies": [],
      "attempts": [
        {
          "run_id": "worker-006",
          "timestamp": "2025-12-12T08:20:00Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "git status --porcelain | wc -l"
            ],
            "results_summary": "Created 2 commits: (1) Removed deprecated LightwaveOS-Production (95 files), (2) Zone-composer feature with web interface (49 files). Updated .gitignore for dev artifacts. git status now shows 0 uncommitted changes."
          },
          "commit": "3e904c0",
          "reverted": false
        }
      ],
      "override_reason": null,
      "notes": "Cleaned. Two commits: 7df70d8 (remove deprecated), 3e904c0 (zone-composer feature)."
    },
    {
      "id": "HARNESS-ENHANCE",
      "title": "Enhance domain memory harness with full protocols",
      "description": "Implement the complete domain memory harness with mutation protocols, validation rules, extracted reference files, and optional Python helper.",
      "acceptance_criteria": [
        "HARNESS_RULES.md documents all mutation protocols",
        "feature_list.json uses v2 schema with attempts[]",
        "ARCHITECTURE.md contains extracted key facts",
        "CONSTRAINTS.md contains extracted hard limits",
        "agent-progress.md has Lessons Learned section"
      ],
      "verification": [
        "cat HARNESS_RULES.md | head -50",
        "cat feature_list.json | grep schema_version",
        "test -f ARCHITECTURE.md && echo exists",
        "test -f CONSTRAINTS.md && echo exists"
      ],
      "status": "PASSING",
      "priority": 1,
      "dependencies": [],
      "attempts": [
        {
          "run_id": "worker-003",
          "timestamp": "2025-12-12T07:55:00Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "ls -la HARNESS_RULES.md ARCHITECTURE.md CONSTRAINTS.md",
              "cat feature_list.json | grep schema_version"
            ],
            "results_summary": "Phase 0-2 complete: HARNESS_RULES.md (300+ lines), feature_list.json v2 schema, ARCHITECTURE.md, CONSTRAINTS.md, Lessons Learned section. Phases 3-4 (harness.py, concurrency) optional."
          },
          "commit": "5da7912",
          "reverted": false
        },
        {
          "run_id": "worker-005",
          "timestamp": "2025-12-12T08:12:00Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "python3 harness.py --help",
              "python3 harness.py validate",
              "python3 harness.py status",
              "python3 harness.py next",
              "python3 harness.py lock worker-005 TEST",
              "python3 harness.py unlock"
            ],
            "results_summary": "Phase 3-4 complete: harness.py (~350 lines) with CLI+library interface, validation, next item selection, concurrency lock. All commands tested and working."
          },
          "commit": "ca458b9",
          "reverted": false
        }
      ],
      "override_reason": null,
      "notes": "Complete. All phases implemented: Phase 0-2 (docs), Phase 3 (harness.py), Phase 4 (concurrency lock)."
    },
    {
      "id": "PERF-TRIG-LOOKUP",
      "title": "Add fast trig lookup tables for effects",
      "description": "Add 256-entry sine/cosine lookup tables to reduce CPU cycles in heavy-math effects. Provides sin8_fast(), cos8_fast(), sinf_fast(), cosf_fast() functions.",
      "acceptance_criteria": [
        "TrigLookup.h and TrigLookup.cpp exist in src/utils/",
        "Lookup tables provide uint8_t, int8_t, and float versions",
        "Build compiles successfully",
        "Available for future effect optimization"
      ],
      "verification": [
        "test -f src/utils/TrigLookup.h && echo exists",
        "pio run -e esp32dev_wifi"
      ],
      "status": "PASSING",
      "priority": 1,
      "dependencies": [],
      "attempts": [
        {
          "run_id": "worker-007",
          "timestamp": "2025-12-12T10:30:00Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "pio run -e esp32dev_wifi"
            ],
            "results_summary": "Created TrigLookup.h (150 lines) and TrigLookup.cpp (100 lines) with 256-entry sine tables. Provides sin8_fast, cos8_fast, sinf_fast, cosf_fast, plus conversion utilities. Build passes - RAM 19.3%, Flash 31.3%."
          },
          "commit": "d58849e",
          "reverted": false
        }
      ],
      "override_reason": null,
      "notes": "Multi-core optimization deferred - lookup tables provide sufficient performance boost with lower risk."
    },
    {
      "id": "OTA-UPDATES",
      "title": "Implement OTA (Over-The-Air) firmware updates",
      "description": "Add ability to flash new firmware over WiFi without USB connection. Use ESP32 ArduinoOTA or AsyncElegantOTA library. Include web interface for upload.",
      "acceptance_criteria": [
        "OTA upload works via web interface",
        "Progress indicator during upload",
        "Automatic reboot after successful flash",
        "Rollback protection (don't brick on bad upload)"
      ],
      "verification": [
        "grep -rn 'OTA\\|Update' src/",
        "curl -X POST http://lightwaveos.local/update"
      ],
      "status": "PASSING",
      "priority": 2,
      "dependencies": [
        "VERIFY-WIFI-BUILD"
      ],
      "attempts": [
        {
          "run_id": "worker-007",
          "timestamp": "2025-12-12T10:25:00Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "pio run -e esp32dev_wifi"
            ],
            "results_summary": "OTA endpoint already existed at /update in WebServer.cpp. Enabled FEATURE_OTA_UPDATE flag. Added Firmware Update card to web UI with file picker, progress bar, status messages. Dual-slot partition table supports rollback. Build passes."
          },
          "commit": "d58849e",
          "reverted": false
        }
      ],
      "override_reason": null,
      "notes": "OTA endpoint existed, just needed UI. Web interface now has full upload capability with progress indicator."
    },
    {
      "id": "TEMPO-TRACKING-FIX-001",
      "title": "Tempo Tracker System Overhaul: P0 Bug Fixes + Dual-Bank Goertzel Front-End",
      "description": "Fix 4 critical correctness bugs in TempoTracker (v2/src/audio/tempo/) and implement dual-bank Goertzel analysis to prevent fast onsets from dominating beat detection. Current failure: 99.7% interval rejection due to hat onsets (~0.12s) poisoning beat-scale IOI clock. Root causes: broken beat_tick generation, gating overwrites, unconditional onset timestamp updates, native determinism issues. Solution: unified sample-counter timebase + dual-bank front-end (64-bin HarmonyBank for chroma, 24-bin RhythmBank for beat evidence with kick emphasis).",
      "acceptance_criteria": [
        "AC-1: Native builds use sample_counter timebase (no esp_timer_get_time() in algorithmic code)",
        "AC-2: beat_tick pulses once per beat (phase wrap detection works)",
        "AC-3: Hat-only loops produce zero beat-candidate intervals, confidence < 0.1",
        "AC-4: Idle room noise produces no false beats, noise floor converges < 10s",
        "AC-5: Sustained chords increase chroma_stability, key_clarity > 0.5",
        "AC-6: CPU budget: RhythmBank ≤ 0.6ms, HarmonyBank ≤ 1.0ms, total ≤ 1.1ms/hop avg",
        "AC-7: Memory < 32 KB working RAM",
        "AC-8: 'pio run -e esp32dev_audio' builds without errors/warnings",
        "AC-9: Tempo lock: EDM ≤ 2.0s, worst-case ≤ 5.0s, BPM jitter ≤ ±1 BPM, octave flips ≤ 1/60s",
        "AC-10: Silence/speech decays confidence < 0.1 within 3s"
      ],
      "verification": [
        "pio run -e esp32dev_audio",
        "pio run -e native_test",
        "grep -n 'esp_timer_get_time' v2/src/audio/tempo/TempoTracker.cpp",
        "python3 tools/test_tempo_lock.py --audio samples/edm_138bpm.wav --max-lock-time 2.0",
        "python3 tools/test_tempo_lock.py --audio samples/hats_only.wav --expect-no-lock"
      ],
      "status": "FAILING",
      "priority": 1,
      "dependencies": [],
      "ralph_loop": {
        "enabled": true,
        "max_iterations": 10,
        "current_iteration": 1,
        "convergence_criteria": {
          "build_passes": true,
          "tests_pass": true,
          "acceptance_met": true
        }
      },
      "prd_reference": {
        "file": "TEMPO-TRACKING-FIX-001.json",
        "last_updated": "2026-01-08T06:50:00Z",
        "version": "2.0.0"
      },
      "attempts": [
        {
          "run_id": "run-20260108-103335",
          "timestamp": "2026-01-08T10:33:35.028341Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "pio run -e esp32dev_audio -d firmware/v2",
              "python3 tools/test_tempo_lock.py --help",
              "python3 tools/analyze_intervals.py --help",
              "python3 tools/measure_onset_accuracy.py --help",
              "python3 tools/visualize_tempo_data.py --help"
            ],
            "results_summary": "Phase 0 complete: Created 4 Python validation tools (test_tempo_lock.py, analyze_intervals.py, measure_onset_accuracy.py, visualize_tempo_data.py), 6 ground truth CSV templates, comprehensive README documentation. All tools execute without errors. Build verification passed. Test infrastructure ready for Ralph Loop iterations 2+."
          },
          "commit": "d5825a2"
        },
        {
          "run_id": "run-20260108-124031",
          "timestamp": "2026-01-08T12:40:31.364588Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "pio run -e esp32dev_audio -d firmware/v2"
            ],
            "results_summary": "Phase 1 complete: Fixed all 11 P0/P0.5 bugs - P0-A (beat_tick generation), P0-B (gating), P0-C (onset poisoning CRITICAL FIX for 99.7% rejection rate), P0-D (native determinism verified), P0-E (K1 baseline initialization), P0-F (refractory period 100ms→200ms), P0-G (compilation errors), plus 4 P0.5 diagnostic/logging enhancements. Build SUCCESS (Flash: +460 bytes). Ready for onset accuracy measurement with Phase 0 test tools."
          },
          "commit": "5a24fc8"
        },
        {
          "run_id": "run-20260108-131911",
          "timestamp": "2026-01-08T13:19:11.108753Z",
          "result": "PASSED",
          "evidence": {
            "commands_run": [
              "pio run -e esp32dev_audio"
            ],
            "results_summary": "Phase 2 complete: Dual-bank architecture + 4 critical onset fixes. Created 16 files (12 infrastructure + 4 bank classes), modified 4 existing files. P1-A onset strength weighting (1.0-3.5x), P1-B conditional octave voting (confidence<0.3), P1-C harmonic filtering (chroma stability), P1-D outlier rejection (2σ threshold). Build SUCCESS: 20.3s, RAM 35.2%, Flash 50.6%."
          },
          "commit": "90a9054"
        }
      ],
      "override_reason": null,
      "notes": "Derived from z.md (tempo audit), z1.md (pipeline audit), z3.md (engineering spec), z4.md (coefficient tables), z5.md (debug logs). P0 bugs: beat_tick broken (TempoTracker.cpp:530-537), AudioNode gating overwritten (AudioNode.cpp:942-944), onset poisoning (TempoTracker.cpp:520), native determinism broken (TempoTracker.cpp:22-33). Implementation strategy: fix P0 bugs first, then integrate dual-bank front-end."
    }
  ]
}
