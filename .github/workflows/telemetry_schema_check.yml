name: Telemetry Schema Validation

on:
  pull_request:
    branches: [ main, feat/* ]
    paths:
      - 'firmware-v3/src/network/webserver/WsGateway.cpp'
      - 'firmware-v3/specs/quint/choreo/**/*.jsonl'
      - 'firmware-v3/specs/quint/choreo/tools/validate_telemetry_schema.py'
      - 'firmware-v3/specs/quint/choreo/telemetry/**'
      - '.github/workflows/telemetry_schema_check.yml'
  push:
    branches: [ main, feat/* ]
    paths:
      - 'firmware-v3/src/network/webserver/WsGateway.cpp'
      - 'firmware-v3/specs/quint/choreo/**/*.jsonl'
      - 'firmware-v3/specs/quint/choreo/tools/validate_telemetry_schema.py'
      - 'firmware-v3/specs/quint/choreo/telemetry/**'
      - '.github/workflows/telemetry_schema_check.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Validate curated telemetry traces
        working-directory: firmware-v3/specs/quint/choreo
        run: |
          set -euo pipefail
          echo "Validating curated telemetry traces against schema v1.0.0..."
          FAILED=0
          shopt -s nullglob
          for jsonl_file in traces/curated/*.jsonl; do
            echo "Validating: $jsonl_file"
            if ! python3 tools/validate_telemetry_schema.py "$jsonl_file"; then
              echo "ERROR: $jsonl_file failed schema validation"
              FAILED=1
            fi
          done
          
          if [ "$FAILED" -eq 1 ]; then
            echo "FAILED: One or more telemetry traces violate schema v1.0.0"
            exit 1
          fi
          
          echo "PASS: All curated telemetry traces conform to schema v1.0.0"
      
      - name: Check for missing schemaVersion in firmware
        run: |
          set -euo pipefail
          echo "Checking WsGateway.cpp for schemaVersion in telemetry logs..."
          # Find ws.connect telemetry lines that don't include schemaVersion
          if grep -n '"event":"ws\.connect"' firmware-v3/src/network/webserver/WsGateway.cpp | grep -v 'schemaVersion' >/dev/null; then
            echo "WARNING: Some telemetry logs in WsGateway.cpp may be missing 'schemaVersion' field"
            echo "All telemetry events must include 'schemaVersion' field per TELEMETRY_REGISTRY.md"
            # Non-blocking for now, but should be fixed
          else
            echo "PASS: Telemetry logs appear to include schemaVersion (manual verification recommended)"
          fi
