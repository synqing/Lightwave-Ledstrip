<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>K1-Lightwave Prototype — Interactive Wiring Schematic</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f172a;
      --panel2:#0b1224;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#1f2937;
      --accent:#7c3aed;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      /* Net colors */
      --net-5v:#60a5fa;
      --net-gnd:#a3a3a3;
      --net-bat:#f472b6;
      --net-3v3:#34d399;
      --net-data:#a78bfa;
      --net-i2s:#fb7185;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 0%, rgba(124,58,237,0.22), transparent 60%),
                  radial-gradient(900px 600px at 90% 30%, rgba(96,165,250,0.16), transparent 55%),
                  linear-gradient(180deg, var(--bg), #070a12 70%);
      height:100vh;
      overflow:hidden;
    }

    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 1fr 380px;
      grid-template-rows: 58px 1fr;
      gap:12px;
      padding:12px;
    }

    .topbar{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }

    .dot{
      width:12px;height:12px;border-radius:999px;
      background: conic-gradient(from 180deg, #60a5fa, #a78bfa, #fb7185, #34d399, #60a5fa);
      box-shadow: 0 0 0 6px rgba(124,58,237,0.12);
    }

    .title{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .title strong{font-size:14px}
    .title span{font-size:12px;color:var(--muted)}

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.08);
      color:var(--text);
      font-size:12px;
    }

    .pill input{
      background:transparent;
      border:none;
      color:var(--text);
      outline:none;
      width:170px;
    }

    .btn{
      cursor:pointer;
      border:none;
      color:var(--text);
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,0.10); border-color: rgba(255,255,255,0.16); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(180deg, rgba(124,58,237,0.55), rgba(124,58,237,0.30));
      border-color: rgba(124,58,237,0.55);
    }

    .canvas{
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 12px 34px rgba(0,0,0,0.38);
      backdrop-filter: blur(8px);
    }

    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;
      padding:14px;
      overflow:auto;
      box-shadow: 0 12px 34px rgba(0,0,0,0.38);
      backdrop-filter: blur(8px);
    }

    .section{
      border:1px solid rgba(255,255,255,0.07);
      background: rgba(0,0,0,0.12);
      border-radius:14px;
      padding:12px;
      margin-bottom:12px;
    }

    .section h3{
      margin:0 0 8px 0;
      font-size:13px;
      letter-spacing:0.2px;
    }

    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:6px 10px;
      font-size:12px;
      color: var(--muted);
    }
    .kv b{ color: var(--text); font-weight:600; }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .chip{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      font-size:12px;
      user-select:none;
      transition: background .2s ease, transform .06s ease, border-color .2s ease;
    }
    .chip:hover{ background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.16); }
    .chip:active{ transform: translateY(1px); }
    .chip.selected{ background: rgba(124,58,237,0.15); border-color: rgba(124,58,237,0.5); }

    .swatch{ width:10px;height:10px;border-radius:999px; box-shadow: 0 0 0 3px rgba(255,255,255,0.06); }

    .muted{ color: var(--muted); font-size:12px; line-height:1.35; }

    .callout{
      border-left: 3px solid rgba(245,158,11,0.9);
      padding:10px 10px 10px 12px;
      border-radius:12px;
      background: rgba(245,158,11,0.08);
      border: 1px solid rgba(245,158,11,0.14);
      font-size:12px;
      color: var(--text);
      line-height:1.35;
    }

    .ok{
      border-left-color: rgba(34,197,94,0.9);
      background: rgba(34,197,94,0.08);
      border-color: rgba(34,197,94,0.14);
    }

    .bad{
      border-left-color: rgba(239,68,68,0.9);
      background: rgba(239,68,68,0.08);
      border-color: rgba(239,68,68,0.14);
    }

    /* SVG styling */
    svg{ width:100%; height:100%; }

    .grid{
      opacity:0.20;
    }

    .component rect{
      fill: rgba(255,255,255,0.05);
      stroke: rgba(255,255,255,0.14);
      stroke-width: 1;
      rx: 14;
      transition: stroke .2s ease, fill .2s ease, opacity .2s ease;
    }

    .component .label{
      font-size:13px;
      fill: var(--text);
      font-weight:600;
      transition: opacity .2s ease;
    }

    .component .sublabel{
      font-size:11px;
      fill: var(--muted);
      transition: opacity .2s ease;
    }

    .component.dim rect{ opacity:0.25; }
    .component.dim .label{ opacity:0.25; }
    .component.dim .sublabel{ opacity:0.25; }
    .component.dim .pinText{ opacity:0.25; }

    .component.active rect{
      stroke: rgba(124,58,237,0.9);
      stroke-width: 2;
      fill: rgba(124,58,237,0.08);
    }

    .component.rail rect{
      fill: rgba(96,165,250,0.08);
      stroke: rgba(96,165,250,0.4);
      stroke-width: 1.5;
    }

    .component.hover rect{
      stroke: rgba(124,58,237,0.5);
      stroke-width: 1.5;
    }

    .pin{
      fill: rgba(255,255,255,0.18);
      stroke: rgba(255,255,255,0.30);
      stroke-width: 1;
      transition: fill .2s ease, stroke .2s ease, filter .2s ease;
    }

    .pin.active{
      fill: rgba(124,58,237,0.55);
      stroke: rgba(124,58,237,0.85);
      filter: drop-shadow(0 0 4px rgba(124,58,237,0.6));
    }

    .pin.hover{
      fill: rgba(124,58,237,0.3);
      stroke: rgba(124,58,237,0.6);
    }

    .pinText{
      font-size:11px;
      fill: rgba(229,231,235,0.9);
      transition: opacity .2s ease;
    }

    .wire{
      fill:none;
      stroke-width: 3.2;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity:0.65;
      transition: opacity .2s ease, stroke-width .2s ease, filter .2s ease;
    }

    .wire.thin{ stroke-width: 2.2; opacity:0.55; }

    .wire.net-5v{ stroke: var(--net-5v); }
    .wire.net-gnd{ stroke: var(--net-gnd); }
    .wire.net-bat{ stroke: var(--net-bat); }
    .wire.net-3v3{ stroke: var(--net-3v3); }
    .wire.net-data{ stroke: var(--net-data); }
    .wire.net-i2s{ stroke: var(--net-i2s); }

    .wire.dim{ opacity:0.12; }
    .wire.active{
      opacity:0.95;
      stroke-width: 4.7;
      filter: drop-shadow(0 0 6px currentColor);
    }
    .wire.hover{
      opacity:0.85;
      stroke-width: 3.8;
    }

    .hint{
      position:absolute;
      left:12px;
      bottom:12px;
      padding:9px 10px;
      background: rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      font-size:12px;
      color: rgba(229,231,235,0.85);
      backdrop-filter: blur(10px);
      pointer-events:none;
    }

    .toast{
      position:absolute;
      right:12px;
      bottom:12px;
      padding:10px 12px;
      background: rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:12px;
      font-size:12px;
      color: rgba(229,231,235,0.92);
      backdrop-filter: blur(10px);
      opacity:0;
      transform: translateY(6px);
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{ opacity:1; transform: translateY(0); }

    @media (max-width: 980px){
      body{ overflow:auto; height:auto; }
      .app{ grid-template-columns: 1fr; grid-template-rows: 58px 520px auto; height:auto; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div class="title">
          <strong>K1 Prototype — Interactive Wiring</strong>
          <span>Click net/component. Shift-click for multi-select. Esc to clear.</span>
        </div>
      </div>

      <div class="controls">
        <div class="pill">
          <span style="color:var(--muted)">Search</span>
          <input id="search" placeholder="usb-c, pololu, data_a…" />
        </div>
        <button class="btn" id="zoomOut">−</button>
        <button class="btn" id="zoomReset">Reset</button>
        <button class="btn" id="zoomIn">+</button>
        <button class="btn" id="clear">Clear</button>
        <button class="btn primary" id="exportPng">Export PNG</button>
      </div>
    </div>

    <div class="canvas" id="canvas">
      <svg id="svg" viewBox="0 0 1800 1000" xmlns="http://www.w3.org/2000/svg" aria-label="Interactive schematic">
        <defs>
          <pattern id="smallGrid" width="20" height="20" patternUnits="userSpaceOnUse">
            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="1" />
          </pattern>
          <pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse">
            <rect width="100" height="100" fill="url(#smallGrid)" />
            <path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.11)" stroke-width="1" />
          </pattern>
        </defs>
        <rect class="grid" width="100%" height="100%" fill="url(#grid)" />

        <g id="wires"></g>
        <g id="components"></g>
      </svg>

      <div class="hint">Drag to pan • Scroll to zoom • Shift-click for multi-select</div>
      <div class="toast" id="toast"></div>
    </div>

    <aside class="sidebar">
      <div class="section">
        <h3>Net Legend</h3>
        <div class="legend" id="legend"></div>
        <div class="muted" style="margin-top:10px">Click a net chip to isolate. Shift-click for multi-select.</div>
      </div>

      <div class="section" id="inspector">
        <h3>Inspector</h3>
        <div class="kv" id="kv"></div>
      </div>

      <div class="section">
        <h3>Build Notes</h3>
        <div class="callout ok" style="margin-bottom:10px">
          <b>Power flow:</b> USB‑C → Charger/Boost IN → (BAT pads to LiPo) → Charger/Boost OUT → Pololu VIN → Pololu VOUT → System 5V Rail → Loads.
        </div>
        <div class="callout" style="margin-bottom:10px">
          <b>Grounding:</b> treat GND as one continuous net. Every board must share it.
        </div>
        <div class="callout bad">
          <b>Polarity:</b> BAT+/BAT− and 5V/GND reversals are how you learn about smoke. Triple-check before first power.
        </div>
      </div>

      <div class="section">
        <h3>Quick Actions</h3>
        <div class="muted" style="margin-bottom:10px">These don't change wiring — they help you sanity-check.</div>
        <button class="btn" id="isoPower">Isolate Power Nets</button>
        <button class="btn" id="isoData" style="margin-left:8px">Isolate Data Nets</button>
        <button class="btn" id="isoI2S" style="margin-left:8px">Isolate I2S Nets</button>
      </div>

      <div class="section">
        <h3>Assumptions</h3>
        <div class="muted">
          • LED PCBs each have their own +5V/GND feed from the switched rail.<br/>
          • Two independent LED data lines (A and B).<br/>
          • Mic is SPH0645 wired to GPIO33 (BCLK), GPIO38 (WS), GPIO6 (DOUT).<br/>
          • Level shifter is 74AHCT125 powered from the switched 5V rail.
        </div>
      </div>
    </aside>
  </div>

  <script>
    // ============================================================================
    // LAYOUT CONFIGURATION
    // ============================================================================
    const GRID = 20;
    const LANE_GAP_X = 80;
    const LANE_GAP_Y = 70;
    const MARGIN_X = 60;
    const MARGIN_Y = 60;

    // Component size constants
    const CARD_SIZES = {
      small: { w: 160, h: 120 },
      medium: { w: 180, h: 140 },
      tall: { w: 200, h: 460 },
      wide: { w: 320, h: 140 },
      large: { w: 240, h: 320 },
      rail: { w: 180, h: 200 }
    };

    // Lane definitions (x positions)
    const LANES = {
      SOURCES: MARGIN_X,
      POWER_MGMT: MARGIN_X + CARD_SIZES.small.w + LANE_GAP_X,
      SWITCHING: MARGIN_X + CARD_SIZES.small.w + LANE_GAP_X + CARD_SIZES.tall.w + LANE_GAP_X,
      RAIL: MARGIN_X + CARD_SIZES.small.w + LANE_GAP_X + CARD_SIZES.tall.w + LANE_GAP_X + CARD_SIZES.medium.w + LANE_GAP_X,
      LOADS: MARGIN_X + CARD_SIZES.small.w + LANE_GAP_X + CARD_SIZES.tall.w + LANE_GAP_X + CARD_SIZES.medium.w + LANE_GAP_X + CARD_SIZES.rail.w + LANE_GAP_X,
      ESP32: MARGIN_X + CARD_SIZES.small.w + LANE_GAP_X + CARD_SIZES.tall.w + LANE_GAP_X + CARD_SIZES.medium.w + LANE_GAP_X + CARD_SIZES.rail.w + LANE_GAP_X + CARD_SIZES.wide.w + LANE_GAP_X
    };

    // Band definitions (y positions)
    const BANDS = {
      POWER: MARGIN_Y,
      LED: MARGIN_Y + CARD_SIZES.tall.h + LANE_GAP_Y,
      AUDIO: MARGIN_Y + CARD_SIZES.tall.h + LANE_GAP_Y + CARD_SIZES.wide.h + LANE_GAP_Y
    };

    // Component positions (lane, band, size)
    const COMPONENT_POSITIONS = {
      usb_c: { lane: LANES.SOURCES, band: BANDS.POWER, size: 'small' },
      charger: { lane: LANES.POWER_MGMT, band: BANDS.POWER, size: 'tall' },
      lipo: { lane: LANES.POWER_MGMT, band: BANDS.LED, size: 'small' },
      pololu: { lane: LANES.SWITCHING, band: BANDS.POWER, size: 'medium' },
      rail: { lane: LANES.RAIL, band: BANDS.POWER + 60, size: 'rail' },
      level: { lane: LANES.SWITCHING, band: BANDS.LED, size: 'medium' },
      led_a: { lane: LANES.LOADS, band: BANDS.LED, size: 'wide' },
      led_b: { lane: LANES.LOADS, band: BANDS.LED + 160, size: 'wide' },
      esp32: { lane: LANES.ESP32, band: BANDS.LED + 40, size: 'large' },
      mic: { lane: LANES.LOADS, band: BANDS.AUDIO + 80, size: 'wide' }
    };

    // ============================================================================
    // CONNECTIVITY GRAPH
    // ============================================================================
    const CONNECTIONS = [
      // Power path
      { net: '5v_in', from: ['usb_c', '5V'], to: ['charger', 'IN_5V'] },
      { net: 'gnd', from: ['usb_c', 'GND'], to: ['charger', 'IN_GND'] },
      { net: '5v_out', from: ['charger', 'OUT_5V'], to: ['pololu', 'VIN'] },
      { net: 'gnd', from: ['charger', 'OUT_GND'], to: ['pololu', 'GND'] },
      { net: '5v_sw', from: ['pololu', 'VOUT'], to: ['rail', 'IN'] },
      { net: 'gnd', from: ['pololu', 'GND2'], to: ['rail', 'GND'] },
      { net: '5v_sw', from: ['rail', 'OUT_ESP'], to: ['esp32', '5V'] },
      { net: '5v_sw', from: ['rail', 'OUT_LED_A'], to: ['led_a', '5V'] },
      { net: '5v_sw', from: ['rail', 'OUT_LED_B'], to: ['led_b', '5V'] },
      { net: '5v_sw', from: ['rail', 'OUT_LEVEL'], to: ['level', 'VCC'] },
      { net: 'gnd', from: ['rail', 'GND'], to: ['esp32', 'GND'] },
      { net: 'gnd', from: ['rail', 'GND'], to: ['led_a', 'GND'] },
      { net: 'gnd', from: ['rail', 'GND'], to: ['led_b', 'GND'] },
      { net: 'gnd', from: ['rail', 'GND'], to: ['level', 'GND'] },
      { net: 'gnd', from: ['rail', 'GND'], to: ['mic', 'GND'] },

      // Battery
      { net: 'bat+', from: ['lipo', 'BAT+'], to: ['charger', 'BAT+'] },
      { net: 'bat-', from: ['lipo', 'BAT-'], to: ['charger', 'BAT-'] },

      // LED data paths
      { net: 'data_a', from: ['esp32', 'GPIO_LED_A'], to: ['level', 'A_IN'] },
      { net: 'data_a', from: ['level', 'A_OUT'], to: ['led_a', 'DIN'] },
      { net: 'data_b', from: ['esp32', 'GPIO_LED_B'], to: ['level', 'B_IN'] },
      { net: 'data_b', from: ['level', 'B_OUT'], to: ['led_b', 'DIN'] },

      // I2S audio
      { net: '3v3', from: ['esp32', '3V3'], to: ['mic', '3V3'] },
      { net: 'i2s_bclk', from: ['esp32', 'GPIO33'], to: ['mic', 'BCLK'] },
      { net: 'i2s_ws', from: ['esp32', 'GPIO38'], to: ['mic', 'WS'] },
      { net: 'i2s_dout', from: ['esp32', 'GPIO6'], to: ['mic', 'DOUT'] }
    ];

    // Build connectivity graph
    function buildGraph(connections) {
      const netToPins = new Map();
      const componentToNets = new Map();
      const wireSegments = [];

      connections.forEach(conn => {
        const net = conn.net;
        if (!netToPins.has(net)) netToPins.set(net, new Set());
        if (!componentToNets.has(conn.from[0])) componentToNets.set(conn.from[0], new Set());
        if (!componentToNets.has(conn.to[0])) componentToNets.set(conn.to[0], new Set());

        const fromPin = `${conn.from[0]}.${conn.from[1]}`;
        const toPin = `${conn.to[0]}.${conn.to[1]}`;

        netToPins.get(net).add(fromPin);
        netToPins.get(net).add(toPin);
        componentToNets.get(conn.from[0]).add(net);
        componentToNets.get(conn.to[0]).add(net);

        wireSegments.push({
          net,
          from: { component: conn.from[0], pin: conn.from[1] },
          to: { component: conn.to[0], pin: conn.to[1] }
        });
      });

      return { netToPins, componentToNets, wireSegments };
    }

    const graph = buildGraph(CONNECTIONS);

    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    const state = {
      mode: 'none', // 'none' | 'net' | 'component'
      selectedNets: new Set(),
      selectedComponents: new Set(),
      hoverNet: null,
      hoverComponent: null
    };

    // ============================================================================
    // COMPONENT DEFINITIONS
    // ============================================================================
    const COMPONENTS = {
      usb_c: {
        name: "USB‑C Daughterboard",
        role: "Provides 5V input to the system (source)",
        pins: {
          "5V": { x: 160, y: 40, label: "5V", labelX: 110, labelY: 44 },
          "GND": { x: 160, y: 80, label: "GND", labelX: 102, labelY: 84 }
        }
      },
      charger: {
        name: "Charger/Boost Module (2R2)",
        role: "Charges 1S LiPo and boosts to 5V output",
        pins: {
          "IN_5V": { x: 0, y: 60, label: "IN 5V", labelX: 14, labelY: 64 },
          "IN_GND": { x: 0, y: 100, label: "IN GND", labelX: 14, labelY: 104 },
          "OUT_5V": { x: 200, y: 80, label: "OUT 5V", labelX: 118, labelY: 84 },
          "OUT_GND": { x: 200, y: 120, label: "OUT GND", labelX: 116, labelY: 124 },
          "BAT+": { x: 0, y: 390, label: "BAT+", labelX: 14, labelY: 394 },
          "BAT-": { x: 0, y: 430, label: "BAT−", labelX: 14, labelY: 434 }
        }
      },
      lipo: {
        name: "LiPo 1S (4000 mAh)",
        role: "Energy storage",
        pins: {
          "BAT+": { x: 140, y: 60, label: "BAT+", labelX: 84, labelY: 64 },
          "BAT-": { x: 140, y: 100, label: "BAT−", labelX: 84, labelY: 104 }
        }
      },
      pololu: {
        name: "Pololu Pushbutton",
        role: "Switches system 5V rail on/off",
        pins: {
          "VIN": { x: 0, y: 50, label: "VIN (5V)", labelX: 14, labelY: 54 },
          "GND": { x: 0, y: 90, label: "GND", labelX: 14, labelY: 94 },
          "VOUT": { x: 180, y: 50, label: "VOUT (5V rail)", labelX: 94, labelY: 54 },
          "GND2": { x: 180, y: 90, label: "GND", labelX: 134, labelY: 94 }
        }
      },
      rail: {
        name: "System 5V Rail (Switched)",
        role: "Power distribution node",
        pins: {
          "IN": { x: 0, y: 60, label: "IN", labelX: 14, labelY: 64 },
          "GND": { x: 0, y: 100, label: "GND", labelX: 14, labelY: 104 },
          "OUT_ESP": { x: 180, y: 40, label: "ESP32", labelX: 118, labelY: 44 },
          "OUT_LED_A": { x: 180, y: 70, label: "LED A", labelX: 118, labelY: 74 },
          "OUT_LED_B": { x: 180, y: 100, label: "LED B", labelX: 118, labelY: 104 },
          "OUT_LEVEL": { x: 180, y: 130, label: "Level", labelX: 118, labelY: 134 }
        }
      },
      level: {
        name: "74AHCT125",
        role: "3.3V → 5V data level shifter",
        pins: {
          "VCC": { x: 180, y: 50, label: "VCC (5V)", labelX: 104, labelY: 54 },
          "GND": { x: 180, y: 70, label: "GND", labelX: 118, labelY: 74 },
          "A_IN": { x: 0, y: 110, label: "A in (LED_A)", labelX: 14, labelY: 114 },
          "A_OUT": { x: 180, y: 110, label: "A out", labelX: 94, labelY: 114 },
          "B_IN": { x: 0, y: 170, label: "B in (LED_B)", labelX: 14, labelY: 174 },
          "B_OUT": { x: 180, y: 170, label: "B out", labelX: 94, labelY: 174 }
        }
      },
      led_a: {
        name: "LED PCB A (160 LEDs)",
        role: "WS2812-class LED chain (2020 package)",
        pins: {
          "DIN": { x: 0, y: 60, label: "DIN (via 330Ω)", labelX: 14, labelY: 64 },
          "5V": { x: 320, y: 40, label: "5V", labelX: 258, labelY: 44 },
          "GND": { x: 320, y: 80, label: "GND", labelX: 252, labelY: 84 }
        }
      },
      led_b: {
        name: "LED PCB B (160 LEDs)",
        role: "WS2812-class LED chain (2020 package)",
        pins: {
          "DIN": { x: 0, y: 60, label: "DIN (via 330Ω)", labelX: 14, labelY: 64 },
          "5V": { x: 320, y: 40, label: "5V", labelX: 258, labelY: 44 },
          "GND": { x: 320, y: 80, label: "GND", labelX: 252, labelY: 84 }
        }
      },
      esp32: {
        name: "ESP32‑S3",
        role: "Main controller",
        pins: {
          "5V": { x: 240, y: 40, label: "5V in", labelX: 170, labelY: 44 },
          "GND": { x: 240, y: 80, label: "GND", labelX: 172, labelY: 84 },
          "3V3": { x: 240, y: 120, label: "3.3V", labelX: 172, labelY: 124 },
          "GPIO_LED_A": { x: 0, y: 70, label: "LED_A GPIO (3.3V)", labelX: 14, labelY: 74 },
          "GPIO_LED_B": { x: 0, y: 130, label: "LED_B GPIO (3.3V)", labelX: 14, labelY: 134 },
          "GPIO33": { x: 0, y: 210, label: "GPIO33 BCLK", labelX: 14, labelY: 214 },
          "GPIO38": { x: 0, y: 250, label: "GPIO38 WS/LR", labelX: 14, labelY: 254 },
          "GPIO6": { x: 0, y: 290, label: "GPIO6 DOUT", labelX: 14, labelY: 294 }
        }
      },
      mic: {
        name: "SPH0645 I2S Mic",
        role: "Audio capture",
        pins: {
          "3V3": { x: 320, y: 40, label: "3.3V", labelX: 260, labelY: 44 },
          "GND": { x: 320, y: 80, label: "GND", labelX: 262, labelY: 84 },
          "BCLK": { x: 0, y: 50, label: "BCLK", labelX: 14, labelY: 54 },
          "WS": { x: 0, y: 80, label: "WS/LRCLK", labelX: 14, labelY: 84 },
          "DOUT": { x: 0, y: 110, label: "DOUT", labelX: 14, labelY: 114 }
        }
      }
    };

    const NETS = {
      "5v_in": { label: "5V (USB IN)", color: getCss("--net-5v") },
      "5v_out": { label: "5V (Boost OUT)", color: getCss("--net-5v") },
      "5v_sw": { label: "5V (Switched Rail)", color: getCss("--net-5v") },
      "gnd": { label: "GND", color: getCss("--net-gnd") },
      "bat+": { label: "BAT+", color: getCss("--net-bat") },
      "bat-": { label: "BAT−", color: getCss("--net-bat") },
      "3v3": { label: "3.3V", color: getCss("--net-3v3") },
      "data_a": { label: "DATA_A", color: getCss("--net-data") },
      "data_b": { label: "DATA_B", color: getCss("--net-data") },
      "i2s_bclk": { label: "I2S BCLK", color: getCss("--net-i2s") },
      "i2s_ws": { label: "I2S WS", color: getCss("--net-i2s") },
      "i2s_dout": { label: "I2S DOUT", color: getCss("--net-i2s") }
    };

    function getCss(varName) {
      return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    }

    // ============================================================================
    // ORTHOGONAL WIRE ROUTING
    // ============================================================================
    function router(x1, y1, x2, y2) {
      // Manhattan routing: horizontal → vertical → horizontal
      const midX = (x1 + x2) / 2;
      return `M ${x1} ${y1} L ${midX} ${y1} L ${midX} ${y2} L ${x2} ${y2}`;
    }

    function getPinPosition(componentId, pinName) {
      const pos = COMPONENT_POSITIONS[componentId];
      const comp = COMPONENTS[componentId];
      if (!pos || !comp || !comp.pins[pinName]) return null;
      const size = CARD_SIZES[pos.size];
      return {
        x: pos.lane + comp.pins[pinName].x,
        y: pos.band + comp.pins[pinName].y
      };
    }

    // ============================================================================
    // RENDERING
    // ============================================================================
    const svg = document.getElementById('svg');
    const wiresGroup = document.getElementById('wires');
    const componentsGroup = document.getElementById('components');

    function renderComponents() {
      componentsGroup.innerHTML = '';
      Object.entries(COMPONENTS).forEach(([id, comp]) => {
        const pos = COMPONENT_POSITIONS[id];
        const size = CARD_SIZES[pos.size];
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', `component${id === 'rail' ? ' rail' : ''}`);
        g.dataset.id = id;
        g.setAttribute('transform', `translate(${pos.lane},${pos.band})`);

        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('width', size.w);
        rect.setAttribute('height', size.h);

        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('class', 'label');
        label.setAttribute('x', 14);
        label.setAttribute('y', 26);
        label.textContent = comp.name;

        const sublabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        sublabel.setAttribute('class', 'sublabel');
        sublabel.setAttribute('x', 14);
        sublabel.setAttribute('y', 44);
        sublabel.textContent = comp.role;

        g.appendChild(rect);
        g.appendChild(label);
        g.appendChild(sublabel);

        // Render pins
        Object.entries(comp.pins).forEach(([pinName, pinData]) => {
          const pin = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          pin.setAttribute('class', 'pin');
          pin.dataset.pin = pinName;
          pin.dataset.component = id;
          pin.setAttribute('cx', pinData.x);
          pin.setAttribute('cy', pinData.y);
          pin.setAttribute('r', 8);

          const pinText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          pinText.setAttribute('class', 'pinText');
          pinText.setAttribute('x', pinData.labelX);
          pinText.setAttribute('y', pinData.labelY);
          pinText.textContent = pinData.label;

          g.appendChild(pin);
          g.appendChild(pinText);
        });

        componentsGroup.appendChild(g);
      });
    }

    function renderWires() {
      wiresGroup.innerHTML = '';
      graph.wireSegments.forEach(seg => {
        const fromPos = getPinPosition(seg.from.component, seg.from.pin);
        const toPos = getPinPosition(seg.to.component, seg.to.pin);
        if (!fromPos || !toPos) return;

        const netClass = seg.net.startsWith('5v') ? 'net-5v' :
                        seg.net === 'gnd' ? 'net-gnd' :
                        seg.net.startsWith('bat') ? 'net-bat' :
                        seg.net === '3v3' ? 'net-3v3' :
                        seg.net.startsWith('data') ? 'net-data' :
                        seg.net.startsWith('i2s') ? 'net-i2s' : 'net-5v';

        const isThin = seg.net === '3v3' || seg.net.startsWith('i2s');

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('class', `wire ${netClass}${isThin ? ' thin' : ''}`);
        path.dataset.net = seg.net;
        path.setAttribute('d', router(fromPos.x, fromPos.y, toPos.x, toPos.y));
        wiresGroup.appendChild(path);
      });
    }

    // ============================================================================
    // INTERACTION HANDLERS
    // ============================================================================
    function toggleNet(net, additive = false) {
      if (!additive) {
        state.selectedComponents.clear();
        state.mode = 'net';
      }
      if (state.selectedNets.has(net)) {
        state.selectedNets.delete(net);
      } else {
        state.selectedNets.add(net);
      }
      if (state.selectedNets.size === 0) {
        state.mode = 'none';
      }
      applyHighlight();
      updateInspector();
      updateLegend();
    }

    function toggleComponent(id, additive = false) {
      if (!additive) {
        state.selectedNets.clear();
        state.mode = 'component';
      }
      if (state.selectedComponents.has(id)) {
        state.selectedComponents.delete(id);
      } else {
        state.selectedComponents.add(id);
      }
      if (state.selectedComponents.size === 0) {
        state.mode = 'none';
      }
      applyHighlight();
      updateInspector();
    }

    function clearSelection() {
      state.mode = 'none';
      state.selectedNets.clear();
      state.selectedComponents.clear();
      state.hoverNet = null;
      state.hoverComponent = null;
      applyHighlight();
      updateInspector();
      updateLegend();
      toastMsg('Cleared.');
    }

    // ============================================================================
    // HIGHLIGHT LOGIC
    // ============================================================================
    function applyHighlight() {
      const wires = [...svg.querySelectorAll('.wire')];
      const comps = [...svg.querySelectorAll('.component')];
      const pins = [...svg.querySelectorAll('.pin')];

      // Reset all
      wires.forEach(w => {
        w.classList.remove('dim', 'active', 'hover');
      });
      comps.forEach(c => {
        c.classList.remove('dim', 'active', 'hover');
      });
      pins.forEach(p => {
        p.classList.remove('active', 'hover');
      });

      if (state.mode === 'net' && state.selectedNets.size > 0) {
        // Net mode: dim non-selected wires, highlight selected
        wires.forEach(w => {
          const net = w.dataset.net;
          if (state.selectedNets.has(net)) {
            w.classList.add('active');
          } else {
            w.classList.add('dim');
          }
        });

        // Components connected to selected nets stay visible
        const connectedComponents = new Set();
        state.selectedNets.forEach(net => {
          const pins = graph.netToPins.get(net) || new Set();
          pins.forEach(pinStr => {
            const [compId] = pinStr.split('.');
            connectedComponents.add(compId);
          });
        });

        comps.forEach(c => {
          const id = c.dataset.id;
          if (connectedComponents.has(id)) {
            // Normal visibility
          } else {
            c.classList.add('dim');
          }
        });

        // Find and highlight pins by component/pin matching
        comps.forEach(comp => {
          const compId = comp.dataset.id;
          comp.querySelectorAll('.pin').forEach(pin => {
            const pinName = pin.dataset.pin;
            const pinKey = `${compId}.${pinName}`;
            state.selectedNets.forEach(net => {
              const netPins = graph.netToPins.get(net) || new Set();
              if (netPins.has(pinKey)) {
                pin.classList.add('active');
              }
            });
          });
        });

      } else if (state.mode === 'component' && state.selectedComponents.size > 0) {
        // Component mode: dim non-selected components
        comps.forEach(c => {
          const id = c.dataset.id;
          if (state.selectedComponents.has(id)) {
            c.classList.add('active');
            c.querySelectorAll('.pin').forEach(p => p.classList.add('active'));
          } else {
            c.classList.add('dim');
          }
        });

        // Highlight wires connected to selected components
        const connectedNets = new Set();
        state.selectedComponents.forEach(compId => {
          const nets = graph.componentToNets.get(compId) || new Set();
          nets.forEach(net => connectedNets.add(net));
        });

        wires.forEach(w => {
          const net = w.dataset.net;
          if (connectedNets.has(net)) {
            w.classList.add('active');
          } else {
            w.classList.add('dim');
          }
        });

      } else {
        // No selection - all normal
      }

      // Apply hover states (independent of selection)
      if (state.hoverNet) {
        wires.forEach(w => {
          if (w.dataset.net === state.hoverNet && !state.selectedNets.has(state.hoverNet)) {
            w.classList.add('hover');
          }
        });
      }

      if (state.hoverComponent) {
        const comp = comps.find(c => c.dataset.id === state.hoverComponent);
        if (comp && !state.selectedComponents.has(state.hoverComponent)) {
          comp.classList.add('hover');
        }
      }
    }

    // ============================================================================
    // INSPECTOR & LEGEND
    // ============================================================================
    const kv = document.getElementById('kv');
    const legendEl = document.getElementById('legend');

    function updateInspector() {
      kv.innerHTML = '';
      if (state.mode === 'net' && state.selectedNets.size > 0) {
        const net = Array.from(state.selectedNets)[0];
        const info = NETS[net];
        if (info) {
          addKV('Net', info.label, true);
          addKV('Type', classifyNet(net));
          addKV('Hint', netHint(net));
        }
      } else if (state.mode === 'component' && state.selectedComponents.size > 0) {
        const id = Array.from(state.selectedComponents)[0];
        const comp = COMPONENTS[id];
        if (comp) {
          addKV('Component', comp.name, true);
          addKV('Role', comp.role);
          addKV('Pins', '');
          Object.entries(comp.pins).forEach(([pin, data]) => {
            addKV(pin, data.label);
          });
        }
      }
    }

    function updateLegend() {
      [...legendEl.children].forEach(chip => {
        const net = chip.dataset.net;
        chip.classList.toggle('selected', state.selectedNets.has(net));
      });
    }

    function addKV(k, v, strong = false) {
      const kEl = document.createElement('div');
      kEl.innerHTML = strong ? `<b>${k}</b>` : k;
      const vEl = document.createElement('div');
      vEl.textContent = v;
      kv.appendChild(kEl);
      kv.appendChild(vEl);
    }

    function classifyNet(net) {
      if (net.startsWith('5v')) return 'Power';
      if (net === 'gnd') return 'Reference (Ground)';
      if (net.startsWith('bat')) return 'Battery';
      if (net === '3v3') return 'Logic/Analog Power';
      if (net.startsWith('data')) return 'LED Data';
      if (net.startsWith('i2s')) return 'Audio Digital';
      return 'Other';
    }

    function netHint(net) {
      switch(net){
        case '5v_in': return 'USB‑C 5V going into charger module.';
        case '5v_out': return 'Boosted 5V output feeding Pololu VIN.';
        case '5v_sw': return 'Switched 5V rail feeding ESP + LEDs + level shifter.';
        case 'gnd': return 'Common ground reference — everything shares this.';
        case 'bat+': return 'Battery positive to charger BAT+.';
        case 'bat-': return 'Battery negative to charger BAT−.';
        case '3v3': return 'ESP 3.3V rail to mic.';
        case 'data_a': return 'LED channel A data via level shifter + 330Ω.';
        case 'data_b': return 'LED channel B data via level shifter + 330Ω.';
        case 'i2s_bclk': return 'I2S bit clock (GPIO33) to mic.';
        case 'i2s_ws': return 'I2S word select (GPIO38) to mic.';
        case 'i2s_dout': return 'I2S data out (GPIO6) from mic.';
        default: return '';
      }
    }

    // ============================================================================
    // EVENT HANDLERS
    // ============================================================================
    function setupEventHandlers() {
      // Component clicks
      componentsGroup.addEventListener('click', (e) => {
        const comp = e.target.closest('.component');
        if (comp) {
          e.stopPropagation();
          toggleComponent(comp.dataset.id, e.shiftKey);
          toastMsg(`Component: ${COMPONENTS[comp.dataset.id].name}`);
        }
      });

      // Wire clicks
      wiresGroup.addEventListener('click', (e) => {
        const wire = e.target.closest('.wire');
        if (wire) {
          e.stopPropagation();
          toggleNet(wire.dataset.net, e.shiftKey);
          toastMsg(`Net: ${NETS[wire.dataset.net]?.label || wire.dataset.net}`);
        }
      });

      // Legend chip clicks
      Object.entries(NETS).forEach(([net, info]) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.dataset.net = net;
        chip.innerHTML = `<span class="swatch" style="background:${info.color}"></span><span>${info.label}</span>`;
        chip.addEventListener('click', (e) => {
          toggleNet(net, e.shiftKey);
        });
        legendEl.appendChild(chip);
      });

      // Background click clears
      svg.addEventListener('click', (e) => {
        if (e.target === svg || e.target.classList.contains('grid')) {
          clearSelection();
        }
      });

      // Hover handlers
      componentsGroup.addEventListener('mouseover', (e) => {
        const comp = e.target.closest('.component');
        if (comp && !state.selectedComponents.has(comp.dataset.id)) {
          state.hoverComponent = comp.dataset.id;
          applyHighlight();
        }
      });

      componentsGroup.addEventListener('mouseout', (e) => {
        const comp = e.target.closest('.component');
        if (comp) {
          state.hoverComponent = null;
          applyHighlight();
        }
      });

      wiresGroup.addEventListener('mouseover', (e) => {
        const wire = e.target.closest('.wire');
        if (wire && !state.selectedNets.has(wire.dataset.net)) {
          state.hoverNet = wire.dataset.net;
          applyHighlight();
        }
      });

      wiresGroup.addEventListener('mouseout', (e) => {
        const wire = e.target.closest('.wire');
        if (wire) {
          state.hoverNet = null;
          applyHighlight();
        }
      });

      // ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          clearSelection();
        }
      });

      // Search
      const search = document.getElementById('search');
      search.addEventListener('input', () => {
        const q = search.value.trim().toLowerCase();
        if (!q) {
          applyHighlight();
          return;
        }

        for (const [net, info] of Object.entries(NETS)) {
          if (net.includes(q) || info.label.toLowerCase().includes(q)) {
            state.selectedComponents.clear();
            state.selectedNets.clear();
            state.selectedNets.add(net);
            state.mode = 'net';
            applyHighlight();
            updateInspector();
            updateLegend();
            return;
          }
        }

        for (const [id, comp] of Object.entries(COMPONENTS)) {
          if (id.includes(q) || comp.name.toLowerCase().includes(q)) {
            state.selectedNets.clear();
            state.selectedComponents.clear();
            state.selectedComponents.add(id);
            state.mode = 'component';
            applyHighlight();
            updateInspector();
            return;
          }
        }
      });

      // Quick actions
      document.getElementById('isoPower').addEventListener('click', () => {
        state.selectedComponents.clear();
        state.selectedNets.clear();
        state.selectedNets.add('5v_sw');
        state.mode = 'net';
        applyHighlight();
        updateInspector();
        updateLegend();
        toastMsg('Isolated: power rail (5V switched).');
      });

      document.getElementById('isoData').addEventListener('click', () => {
        state.selectedComponents.clear();
        state.selectedNets.clear();
        state.selectedNets.add('data_a');
        state.mode = 'net';
        applyHighlight();
        updateInspector();
        updateLegend();
        toastMsg('Isolated: DATA_A (click DATA_B in legend for B).');
      });

      document.getElementById('isoI2S').addEventListener('click', () => {
        state.selectedComponents.clear();
        state.selectedNets.clear();
        state.selectedNets.add('i2s_bclk');
        state.mode = 'net';
        applyHighlight();
        updateInspector();
        updateLegend();
        toastMsg('Isolated: I2S BCLK (use legend for WS/DOUT).');
      });

      document.getElementById('clear').addEventListener('click', clearSelection);
    }

    // ============================================================================
    // PAN/ZOOM
    // ============================================================================
    const canvas = document.getElementById('canvas');
    const toast = document.getElementById('toast');
    let viewBox = { x: 0, y: 0, w: 1800, h: 1000 };
    const original = { ...viewBox };
    let isPanning = false;
    let panStart = { x: 0, y: 0, vbX: 0, vbY: 0 };

    function setViewBox() {
      svg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);
    }

    function zoom(factor, cx = null, cy = null) {
      const mx = cx ?? (viewBox.x + viewBox.w / 2);
      const my = cy ?? (viewBox.y + viewBox.h / 2);
      const newW = viewBox.w * factor;
      const newH = viewBox.h * factor;
      viewBox.x = mx - (mx - viewBox.x) * factor;
      viewBox.y = my - (my - viewBox.y) * factor;
      viewBox.w = newW;
      viewBox.h = newH;
      clampViewBox();
      setViewBox();
    }

    function clampViewBox() {
      const minW = 600;
      const maxW = 2400;
      viewBox.w = Math.max(minW, Math.min(maxW, viewBox.w));
      viewBox.h = viewBox.w * (original.h / original.w);
      const pad = 200;
      const minX = -pad;
      const minY = -pad;
      const maxX = original.w + pad - viewBox.w;
      const maxY = original.h + pad - viewBox.h;
      viewBox.x = Math.max(minX, Math.min(maxX, viewBox.x));
      viewBox.y = Math.max(minY, Math.min(maxY, viewBox.y));
    }

    function clientToSvgPoint(clientX, clientY) {
      const rect = svg.getBoundingClientRect();
      const x = (clientX - rect.left) / rect.width;
      const y = (clientY - rect.top) / rect.height;
      return {
        x: viewBox.x + x * viewBox.w,
        y: viewBox.y + y * viewBox.h
      };
    }

    canvas.addEventListener('mousedown', (e) => {
      const target = e.target;
      const isInteractive = target.closest && (target.closest('.component') || target.classList?.contains('wire'));
      if (isInteractive) return;
      isPanning = true;
      const p = clientToSvgPoint(e.clientX, e.clientY);
      panStart = { x: p.x, y: p.y, vbX: viewBox.x, vbY: viewBox.y };
      canvas.style.cursor = 'grabbing';
    });

    window.addEventListener('mousemove', (e) => {
      if (!isPanning) return;
      const p = clientToSvgPoint(e.clientX, e.clientY);
      const dx = p.x - panStart.x;
      const dy = p.y - panStart.y;
      viewBox.x = panStart.vbX - dx;
      viewBox.y = panStart.vbY - dy;
      clampViewBox();
      setViewBox();
    });

    window.addEventListener('mouseup', () => {
      if (!isPanning) return;
      isPanning = false;
      canvas.style.cursor = 'default';
    });

    canvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      const p = clientToSvgPoint(e.clientX, e.clientY);
      const factor = e.deltaY > 0 ? 1.10 : 0.90;
      zoom(factor, p.x, p.y);
    }, { passive: false });

    document.getElementById('zoomIn').addEventListener('click', () => zoom(0.90));
    document.getElementById('zoomOut').addEventListener('click', () => zoom(1.10));
    document.getElementById('zoomReset').addEventListener('click', () => {
      viewBox = { ...original };
      setViewBox();
      toastMsg('View reset.');
    });

    // Export PNG
    document.getElementById('exportPng').addEventListener('click', async () => {
      try {
        const svgText = new XMLSerializer().serializeToString(svg);
        const svgBlob = new Blob([svgText], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);
        const img = new Image();
        img.crossOrigin = 'anonymous';
        await new Promise((res, rej) => {
          img.onload = res;
          img.onerror = rej;
          img.src = url;
        });

        const scale = 2;
        const c = document.createElement('canvas');
        c.width = 1800 * scale;
        c.height = 1000 * scale;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#0b0f17';
        ctx.fillRect(0, 0, c.width, c.height);
        ctx.drawImage(img, 0, 0, c.width, c.height);

        URL.revokeObjectURL(url);
        const pngUrl = c.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = pngUrl;
        a.download = 'k1-prototype-wiring.png';
        a.click();
        toastMsg('Exported PNG.');
      } catch (err) {
        console.error(err);
        toastMsg('Export failed (browser blocked).');
      }
    });

    function toastMsg(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(() => toast.classList.remove('show'), 1600);
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    renderComponents();
    renderWires();
    setupEventHandlers();
    updateInspector();
    updateLegend();
    setViewBox();
  </script>
</body>
</html>
