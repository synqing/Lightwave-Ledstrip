// K1_GoertzelTables_16k.h
#pragma once
/*
  Exact GoertzelBinSpec tables for K1 Dual-Bank Front-End
  Fs = 16000 Hz

  HarmonyBank (64):
    - Semitone bins from A2 (110.0 Hz) upward: f[n] = 110 * 2^(n/12), n=0..63
    - Window sizing policy (already applied in the table):
        dist = max( f[n]-f[n-1], f[n+1]-f[n] )  (edges use single neighbor)
        N_raw = round(Fs / (2 * dist))
        N = clamp(N_raw, 256, 1536)

  RhythmBank (24):
    - Evidence bins for kick/snare/presence/transients
    - Fixed N by band (already applied in the table):
        f <= 120 Hz  -> N = 1536
        f <= 400 Hz  -> N = 1024
        f <= 1250 Hz -> N = 512
        else         -> N = 256

  k and coeff_q14:
    - k = round(N * f / Fs) (provided for debug/reference)
    - coeff_q14 is computed from the *exact target frequency*:
        omega = 2*pi*f/Fs
        coeff = 2*cos(omega)
        coeff_q14 = round(coeff * 16384)

  Hann LUT:
    - Nmax = 1536 (Q15), safe range [0..32767]
*/

#include <stdint.h>
#include <math.h>

static constexpr uint32_t kGoertzelFsHz = 16000;
static constexpr uint16_t kGoertzelNMin = 256;
static constexpr uint16_t kGoertzelNMax = 1536;

struct GoertzelBinSpec {
  float    freq_hz;     // target frequency (Hz)
  uint16_t N;           // window length (samples)
  uint16_t k;           // reference DFT-bin index (rounded)
  int16_t  coeff_q14;   // Q14: round( (2*cos(2*pi*freq/Fs)) * 16384 )
};

static constexpr uint16_t kHannN = 1536;

// Hann window LUT generator (Q15).
// out[n] in [0..32767], where 32767 == 1.0
// w[n] = 0.5 * (1 - cos(2*pi*n/(N-1)))
static inline void BuildHannWindowQ15_1536(int16_t* out_q15) {
  const float two_pi = 6.28318530717958647692f;
  const float denom  = (float)(kHannN - 1);
  for (uint16_t n = 0; n < kHannN; ++n) {
    const float x = (float)n / denom;
    const float w = 0.5f * (1.0f - cosf(two_pi * x)); // 0..1
    int32_t q = (int32_t)lroundf(w * 32767.0f);       // Q15
    if (q < 0) q = 0;
    if (q > 32767) q = 32767;
    out_q15[n] = (int16_t)q;
  }
}

// -----------------------------------------------------------------------------
// HarmonyBank: 64 semitone bins from A2 (110 Hz)
// Each line includes note label for sanity checking.
// -----------------------------------------------------------------------------
static const GoertzelBinSpec kHarmonyBins_16k_64[64] = {
  { 110.000000f, 1223, 8, 32737 }, // A2  f=110.000Hz
  { 116.540940f, 1154, 8, 32734 }, // A#2  f=116.541Hz
  { 123.470825f, 1090, 8, 32729 }, // B2  f=123.471Hz
  { 130.812783f, 1028, 8, 32725 }, // C3  f=130.813Hz
  { 138.591315f, 971, 8, 32719 }, // C#3  f=138.591Hz
  { 146.832384f, 916, 8, 32713 }, // D3  f=146.832Hz
  { 155.563492f, 865, 8, 32706 }, // D#3  f=155.563Hz
  { 164.813778f, 816, 8, 32698 }, // E3  f=164.814Hz
  { 174.614116f, 770, 8, 32690 }, // F3  f=174.614Hz
  { 184.997211f, 727, 8, 32680 }, // F#3  f=184.997Hz
  { 195.997718f, 686, 8, 32669 }, // G3  f=195.998Hz
  { 207.652349f, 647, 8, 32657 }, // G#3  f=207.652Hz
  { 220.000000f, 610, 8, 32645 }, // A3  f=220.000Hz
  { 233.081881f, 575, 8, 32631 }, // A#3  f=233.082Hz
  { 246.941651f, 542, 8, 32616 }, // B3  f=246.942Hz
  { 261.625565f, 511, 8, 32601 }, // C4  f=261.626Hz
  { 277.182631f, 482, 8, 32584 }, // C#4  f=277.183Hz
  { 293.664768f, 454, 8, 32566 }, // D4  f=293.665Hz
  { 311.126984f, 428, 8, 32547 }, // D#4  f=311.127Hz
  { 329.627557f, 404, 8, 32527 }, // E4  f=329.628Hz
  { 349.228231f, 381, 8, 32506 }, // F4  f=349.228Hz
  { 369.994423f, 359, 8, 32483 }, // F#4  f=369.994Hz
  { 391.995436f, 338, 8, 32459 }, // G4  f=391.995Hz
  { 415.304698f, 319, 8, 32434 }, // G#4  f=415.305Hz
  { 440.000000f, 301, 8, 32407 }, // A4  f=440.000Hz
  { 466.163762f, 284, 8, 32379 }, // A#4  f=466.164Hz
  { 493.883301f, 269, 8, 32349 }, // B4  f=493.883Hz
  { 523.251131f, 256, 8, 32317 }, // C5  f=523.251Hz
  { 554.365262f, 256, 9, 32284 }, // C#5  f=554.365Hz
  { 587.329536f, 256, 9, 32248 }, // D5  f=587.330Hz
  { 622.253967f, 256, 10, 32211 }, // D#5  f=622.254Hz
  { 659.255114f, 256, 11, 32171 }, // E5  f=659.255Hz
  { 698.456462f, 256, 11, 32128 }, // F5  f=698.456Hz
  { 739.988845f, 256, 12, 32083 }, // F#5  f=739.989Hz
  { 783.990872f, 256, 13, 32035 }, // G5  f=783.991Hz
  { 830.609395f, 256, 13, 31983 }, // G#5  f=830.609Hz
  { 880.000000f, 256, 14, 31928 }, // A5  f=880.000Hz
  { 932.327523f, 256, 15, 31869 }, // A#5  f=932.328Hz
  { 987.766603f, 256, 16, 31807 }, // B5  f=987.767Hz
  { 1046.502261f, 256, 17, 31741 }, // C6  f=1046.502Hz
  { 1108.730524f, 256, 18, 31670 }, // C#6  f=1108.731Hz
  { 1174.659072f, 256, 19, 31596 }, // D6  f=1174.659Hz
  { 1244.507935f, 256, 20, 31516 }, // D#6  f=1244.508Hz
  { 1318.510228f, 256, 21, 31431 }, // E6  f=1318.510Hz
  { 1396.912925f, 256, 22, 31341 }, // F6  f=1396.913Hz
  { 1479.977691f, 256, 24, 31245 }, // F#6  f=1479.978Hz
  { 1567.981744f, 256, 25, 31142 }, // G6  f=1567.982Hz
  { 1661.218790f, 256, 27, 31034 }, // G#6  f=1661.219Hz
  { 1760.000000f, 256, 28, 30918 }, // A6  f=1760.000Hz
  { 1864.655046f, 256, 30, 30795 }, // A#6  f=1864.655Hz
  { 1975.533205f, 256, 32, 30664 }, // B6  f=1975.533Hz
  { 2093.004522f, 256, 33, 30525 }, // C7  f=2093.005Hz
  { 2217.461048f, 256, 35, 30376 }, // C#7  f=2217.461Hz
  { 2349.318143f, 256, 38, 30218 }, // D7  f=2349.318Hz
  { 2489.015870f, 256, 40, 30049 }, // D#7  f=2489.016Hz
  { 2637.020455f, 256, 42, 29870 }, // E7  f=2637.020Hz
  { 2793.825851f, 256, 45, 29678 }, // F7  f=2793.826Hz
  { 2959.955382f, 256, 47, 29475 }, // F#7  f=2959.955Hz
  { 3135.963488f, 256, 50, 29259 }, // G7  f=3135.963Hz
  { 3322.437581f, 256, 53, 29030 }, // G#7  f=3322.438Hz
  { 3520.000000f, 256, 56, 28788 }, // A7  f=3520.000Hz
  { 3729.310092f, 256, 60, 28531 }, // A#7  f=3729.310Hz
  { 3951.066410f, 256, 63, 28261 }, // B7  f=3951.066Hz
  { 4186.009045f, 256, 67, -2391 }, // C8  f=4186.009Hz
};

static_assert(sizeof(kHarmonyBins_16k_64) / sizeof(kHarmonyBins_16k_64[0]) == 64,
              "Harmony bin table must have 64 entries");

// -----------------------------------------------------------------------------
// RhythmBank: 24 evidence bins
// -----------------------------------------------------------------------------
static const GoertzelBinSpec kRhythmBins_16k_24[24] = {
  { 35.000000f, 1536, 3, 32765 }, // f=35.0Hz
  { 45.000000f, 1536, 4, 32763 }, // f=45.0Hz
  { 55.000000f, 1536, 5, 32760 }, // f=55.0Hz
  { 70.000000f, 1536, 7, 32756 }, // f=70.0Hz
  { 85.000000f, 1536, 8, 32750 }, // f=85.0Hz
  { 100.000000f, 1536, 10, 32741 }, // f=100.0Hz
  { 120.000000f, 1536, 12, 32729 }, // f=120.0Hz
  { 160.000000f, 1024, 10, 32706 }, // f=160.0Hz
  { 200.000000f, 1024, 13, 32685 }, // f=200.0Hz
  { 250.000000f, 1024, 16, 32655 }, // f=250.0Hz
  { 315.000000f, 1024, 20, 32610 }, // f=315.0Hz
  { 400.000000f, 1024, 26, 32543 }, // f=400.0Hz
  { 500.000000f, 512, 16, 32479 }, // f=500.0Hz
  { 630.000000f, 512, 20, 32369 }, // f=630.0Hz
  { 800.000000f, 512, 26, 32186 }, // f=800.0Hz
  { 1000.000000f, 512, 32, 31928 }, // f=1000.0Hz
  { 1250.000000f, 512, 40, 31516 }, // f=1250.0Hz
  { 2000.000000f, 256, 32, 28898 }, // f=2000.0Hz
  { 2500.000000f, 256, 40, 23098 }, // f=2500.0Hz
  { 3150.000000f, 256, 50, 10980 }, // f=3150.0Hz
  { 4000.000000f, 256, 64, -1 }, // f=4000.0Hz
  { 5000.000000f, 256, 80, -12540 }, // f=5000.0Hz
  { 6300.000000f, 256, 101, -25733 }, // f=6300.0Hz
  { 7500.000000f, 256, 120, -32138 }, // f=7500.0Hz
};

static_assert(sizeof(kRhythmBins_16k_24) / sizeof(kRhythmBins_16k_24[0]) == 24,
              "Rhythm bin table must have 24 entries");
