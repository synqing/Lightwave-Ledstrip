# Effects 39-43 Fixes - Root Cause Analysis and Resolution

**Date:** 2025-12-23  
**Effects:** 39 (LGP Fluid Dynamics), 40 (LGP Quantum Tunneling), 41 (LGP Gravitational Lensing), 42 (LGP Time Crystal), 43 (LGP Soliton Waves)

## Issues Reported

1. **Effect 39**: LGP Fluid Dynamics - General issues
2. **Effect 40**: LGP Quantum Tunneling - Colour issue with static sections
3. **Effect 41**: LGP Gravitational Lensing - White issue
4. **Effect 42**: LGP Time Crystal - White issues
5. **Effect 43**: LGP Soliton Waves - Visualisation behaving weirdly

## Root Cause Analysis

### Code Issues Identified

1. **Effect 40 (Quantum Tunneling)**:
   - **Issue**: Lines 129-131 used `CRGB::White` for flash effects when particles tunnel through barriers
   - **Impact**: Static barrier sections showing white flashes instead of colored effects
   - **Root Cause**: Hardcoded white color doesn't respect palette or particle colors

2. **Effect 41 (Gravitational Lensing)**:
   - **Issue**: Line 226 set `brightness = 255` when deflection > 0.5f
   - **Impact**: High deflection regions appearing white/saturated
   - **Root Cause**: Maximum brightness combined with palette lookup can produce white colors

3. **Effect 42 (Time Crystal)**:
   - **Issue 1**: Line 255 used `abs((float)i - CENTER_LEFT)` instead of `centerPairDistance(i)`
   - **Impact**: Incorrect center distance calculation, causing visual drift
   - **Root Cause**: Old center distance calculation not updated during refactor
   - **Issue 2**: Lines 274-275 set `brightness = 255` and `paletteIndex = 0` when crystal > 0.9f
   - **Impact**: High crystal regions appearing white (palette index 0 often maps to white)
   - **Root Cause**: Hardcoded white color via palette index 0

4. **Effect 43 (Soliton Waves)**:
   - **Issue**: Lines 313-315 used `CRGB::White` for collision flashes
   - **Impact**: Collision events appearing as white flashes instead of colored effects
   - **Root Cause**: Hardcoded white color doesn't blend soliton colors

5. **Color Correction Impact**:
   - **Issue**: Effects 39-43 are LGP physics-based effects with CENTER_ORIGIN and PHYSICS tags, but were not included in the LGP-sensitive skip list
   - **Impact**: ColorCorrectionEngine was applying per-frame corrections (white guardrail, gamma) that break amplitude relationships needed for LGP interference patterns
   - **Root Cause**: `isLGPSensitive()` only checked INTERFERENCE and ADVANCED_OPTICAL families, not QUANTUM or ORGANIC families

## Fixes Applied

### 1. Effect 40 (Quantum Tunneling) - Flash Color Fix

**File**: `v2/src/effects/LGPQuantumEffects.cpp` (lines 125-134)

**Before**:
```cpp
ctx.leds[flashPos] = CRGB::White;
```

**After**:
```cpp
uint8_t flashHue = ctx.hue + p * 25;
ctx.leds[flashPos] = CHSV(flashHue, 255, flashBright);
```

**Result**: Flash effects now use particle-specific colors instead of white.

### 2. Effect 41 (Gravitational Lensing) - White Saturation Fix

**File**: `v2/src/effects/LGPQuantumEffects.cpp` (lines 225-227)

**Before**:
```cpp
if (abs(totalDeflection) > 0.5f) {
    brightness = 255;
}
```

**After**:
```cpp
if (abs(totalDeflection) > 0.5f) {
    brightness = 240;  // Slightly below 255 to avoid white guardrail
    paletteIndex = (uint8_t)(abs(totalDeflection) * 30);  // Use deflection-based color
}
```

**Result**: High deflection regions use bright colors from palette instead of white saturation.

### 3. Effect 42 (Time Crystal) - Center Distance and White Fix

**File**: `v2/src/effects/LGPQuantumEffects.cpp` (lines 254-276)

**Before**:
```cpp
float distFromCenter = abs((float)i - CENTER_LEFT) / CENTER_LEFT;
// ...
if (abs(crystal) > 0.9f) {
    brightness = 255;
    paletteIndex = 0;
}
```

**After**:
```cpp
float distFromCenter = (float)centerPairDistance((uint16_t)i) / (float)HALF_LENGTH;
// ...
if (abs(crystal) > 0.9f) {
    brightness = 240;  // Slightly below 255 to avoid white guardrail
    paletteIndex = (uint8_t)(abs(crystal) * 50);  // Use crystal value for color
}
```

**Result**: 
- Center distance calculation now uses correct `centerPairDistance()` function
- High crystal regions use bright palette colors instead of white (palette index 0)

### 4. Effect 43 (Soliton Waves) - Collision Color Fix

**File**: `v2/src/effects/LGPQuantumEffects.cpp` (lines 311-317)

**Before**:
```cpp
ctx.leds[collisionPos] = CRGB::White;
```

**After**:
```cpp
uint8_t blendHue = (solitonHue[s] + solitonHue[other]) / 2;
uint8_t blendBright = qadd8(solitonAmp[s], solitonAmp[other]) / 2;
ctx.leds[collisionPos] = CHSV(blendHue + ctx.hue, 255, blendBright);
```

**Result**: Collision flashes now blend the colors of the colliding solitons instead of white.

### 5. Color Correction Skip Policy Update

**File**: `v2/src/effects/PatternRegistry.cpp` (lines 223-232)

**Added**:
```cpp
// Check if effect is in QUANTUM or ORGANIC family with CENTER_ORIGIN and PHYSICS tags
// These are LGP physics-based effects that need precise amplitude relationships
if ((metadata->family == PatternFamily::QUANTUM || metadata->family == PatternFamily::ORGANIC) &&
    metadata->hasTag(PatternTags::CENTER_ORIGIN) && 
    metadata->hasTag(PatternTags::PHYSICS)) {
    return true;
}
```

**Result**: Effects 39-43 now skip ColorCorrectionEngine per-frame processing, preserving LGP amplitude relationships.

## Verification

### Expected Improvements

1. **Effect 40**: Static barrier sections should show correct colors, flash effects should be colored
2. **Effect 41**: High deflection regions should show bright colors instead of white
3. **Effect 42**: Center distance calculation should be correct, high crystal regions should show bright colors instead of white
4. **Effect 43**: Collision events should show blended colors instead of white flashes
5. **All Effects**: ColorCorrectionEngine should be skipped, preserving LGP physics amplitude relationships

### Testing Recommendations

1. **Visual Inspection**: Test each effect and verify:
   - No white artifacts in static sections (Effect 40)
   - No white saturation in high-intensity regions (Effects 41, 42)
   - No white collision flashes (Effect 43)
   - Correct center-origin behavior (Effect 42)

2. **Capture Analysis**: Re-run captures for effects 39-43 and verify:
   - Tap A (pre-correction) matches baseline
   - Tap B (post-correction) should be same as Tap A (correction skipped)
   - LGP metrics (edge ratio drift, low-value crush, symmetry) should improve

3. **Performance**: Verify no FPS degradation from additional `isLGPSensitive()` checks

## Files Modified

1. `v2/src/effects/LGPQuantumEffects.cpp` - Fixed white color issues and center distance calculation
2. `v2/src/effects/PatternRegistry.cpp` - Extended `isLGPSensitive()` to include QUANTUM and ORGANIC families

## Summary

All identified issues have been addressed:
- **White color issues**: Replaced hardcoded `CRGB::White` with palette-based or blended colors
- **Center distance**: Fixed Effect 42 to use `centerPairDistance()` instead of old `abs()` calculation
- **Color correction**: Extended LGP-sensitive detection to include effects 39-43

These fixes should resolve the reported visual issues while maintaining LGP physics accuracy.

