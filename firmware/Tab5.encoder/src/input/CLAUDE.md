# Canonical I2C & Encoder Architecture

## Hardware

- **Bus**: Single I2C bus on Grove Port.A (GPIO 53 SDA, GPIO 54 SCL, 100 kHz)
- **Unit A**: M5ROTATE8 @ 0x42 (reprogrammed via register 0xFF) -- encoders 0-7 (global params)
- **Unit B**: M5ROTATE8 @ 0x41 (factory default) -- encoders 8-15 (zone params)
- **Internal I2C** (GPIO 31/32): Display, touch, audio -- **NEVER TOUCH**

## Boot Detection Protocol

1. `Wire.begin(53, 54, 100000)` initialises external bus
2. `I2CRecovery::init()` sets up recovery module
3. `delay(100)` for bus settle
4. `scanI2CBus()` diagnostic scan (1-126)
5. `DualEncoderService::begin()` with **exponential backoff retry** (5 attempts, 200-3200ms)
6. If all attempts fail, system continues but starts 2-minute reboot timer

## Recovery Architecture (3 layers)

| Layer | Trigger | Mechanism |
|-------|---------|-----------|
| **Boot retry** | Detection failure | 5 attempts with exponential backoff (200ms-3200ms) |
| **Re-probe** | Missing encoder at runtime | Every 10 seconds, `reinit()` on unavailable transports |
| **I2CRecovery** | 5 consecutive I2C errors | Multi-level: SCL toggling -> hw peripheral reset -> Wire reinit |
| **Reboot** | No encoders for 2 minutes | `esp_restart()` hard reboot |

## Critical Ordering Constraint

`setWiFiAntenna()` must be called **AFTER** `Wire.begin()` and encoder detection. `M5.getIOExpander(0)` accesses the internal I2C bus and can corrupt external bus state on ESP32-P4.

## Files

| File | Purpose |
|------|---------|
| `Rotate8Transport.h` | M5ROTATE8 I2C transport with error tracking |
| `DualEncoderService.h` | Dual-unit service (polling, debounce, callbacks) |
| `I2CRecovery.h/cpp` | Multi-level bus recovery state machine |
| `EncoderProcessing.h` | Delta processing (debounce, wrap, clamp) |

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Jan 3, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #10998 | 4:05 AM | ðŸŸ£ | Recovery escalation tracking added to completeRecovery function | ~343 |
| #10995 | " | ðŸŸ£ | Implemented Hardware Peripheral Reset with i2c_ll_reset_register | ~408 |
| #10984 | 4:04 AM | ðŸŸ£ | Software Attempt Counter Added to I2C Recovery State | ~270 |
| #10983 | " | âœ… | I2C recovery implementation updated with ESP32-P4 hardware reset includes | ~363 |
| #10981 | " | ðŸŸ£ | Added Hardware Peripheral Reset Method Declaration to I2CRecovery | ~318 |
| #10979 | 4:03 AM | ðŸŸ£ | I2C Recovery Escalation Policy Configured | ~262 |
| #10978 | " | âœ… | I2C recovery upgraded to multi-level strategy with hardware reset | ~371 |
| #10977 | " | ðŸ”µ | Tab5.encoder Current I2CRecovery Software-Only Implementation | ~507 |

### Jan 30, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #23458 | 11:24 AM | ðŸ”µ | Touch Handler Debug Output Location | ~284 |
</claude-mem-context>