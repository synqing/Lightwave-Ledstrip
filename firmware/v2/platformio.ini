; PlatformIO Configuration for LightwaveOS v2
;
; Next-gen platform architecture with:
; - Actor model for cross-core communication
; - Plugin system with IEffect interface
; - CQRS state management
; - Multi-device synchronization
; - Audio-reactive effects with SPH0645 I2S microphone
;
; Build commands:
;   pio run                    # Default build (audio-enabled)
;   pio run -t upload          # Build and upload
;   pio run -e native_test     # Unit tests on host
;
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = esp32dev_audio
description = LightwaveOS v2 - Next-Gen LED Control Platform
; Include WiFi credentials from gitignored file (if it exists)
; Copy wifi_credentials.ini.template to wifi_credentials.ini and edit
extra_configs = wifi_credentials.ini

[common]
build_flags =
	-std=gnu++17
	-Werror=deprecated-declarations
	-O3
	-ffast-math
	-funroll-loops
	-D ARDUINO_USB_MODE=1
	-D ARDUINO_USB_CDC_ON_BOOT=1
	-D CONFIG_TINYUSB_CDC_ENABLED=1
	-D DISABLE_ALL_LIBRARY_WARNINGS
	-D CONFIG_ASYNC_TCP_RUNNING_CORE=1
	-D CONFIG_ASYNC_TCP_USE_WDT=0
	-D FASTLED_RMT_BUILTIN_DRIVER=1
	-D FASTLED_ALLOW_INTERRUPTS=0
	-D FASTLED_ESP32_FLASH_LOCK=0
	-D FASTLED_INTERRUPT_RETRY_COUNT=0
	-D CONFIG_FREERTOS_ASSERT_FAIL_ABORT=1
	-D configASSERT_DEFINED=1
	; Stack overflow protection (Method 2: check on context switch)
	-D configCHECK_FOR_STACK_OVERFLOW=2
	-D configUSE_MALLOC_FAILED_HOOK=1
	; FreeRTOS task statistics (required for uxTaskGetSystemState)
	-D configUSE_TRACE_FACILITY=1
	-D configUSE_STATS_FORMATTING_FUNCTIONS=1
	; Heap corruption detection
	-D CONFIG_HEAP_CORRUPTION_DETECTION=1
	-D CONFIG_HEAP_POISONING_COMPREHENSIVE=1
	; Feature flags for monitoring
	-D FEATURE_HEAP_MONITORING=1
	-D FEATURE_MEMORY_LEAK_DETECTION=1
	-D FEATURE_VALIDATION_PROFILING=1
	-D FEATURE_STACK_PROFILING=1
	; v2 feature flags
	-D LIGHTWAVEOS_V2=1
	-D FEATURE_ACTOR_SYSTEM=1
	-D FEATURE_PLUGIN_RUNTIME=1
	-D FEATURE_CQRS_STATE=1
	-D FEATURE_HAL_ABSTRACTION=1
	; Network features
	-D FEATURE_WEB_SERVER=1
	; Audio features (always enabled)
	-D FEATURE_AUDIO_SYNC=1
	-D FEATURE_MULTI_DEVICE=1
	; Logging: 0=None, 1=Error, 2=Warn, 3=Info, 4=Debug
	; LW_LOG_LEVEL defined per-environment (not in common to avoid redefinition warnings)

[env:esp32dev_audio]
platform = espressif32@6.9.0
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 115200
upload_port = /dev/cu.usbmodem21401
board_build.f_cpu = 240000000L
board_build.flash_mode = dio
board_build.filesystem = littlefs
board_build.arduino.memory_type = qio_opi
board_upload.flash_size = 8MB
build_unflags = -std=gnu++11
build_flags =
	${common.build_flags}
	-D CORE_DEBUG_LEVEL=4
	-D LW_LOG_LEVEL=4
	${wifi_credentials.build_flags}
	-D FEATURE_EFFECT_VALIDATION=0
	-I.pio/libdeps/esp32dev_audio/FastLED/src/third_party/cq_kernel
lib_ldf_mode = deep+
lib_deps =
	fastled/FastLED@3.10.0
	bblanchon/ArduinoJson@7.0.4
	esp32async/ESPAsyncWebServer@3.9.3
	esp32async/AsyncTCP@3.4.9
	Pharap/FixedPoints@^1.1.2
; Sync subsystem uses ESP-IDF native esp_websocket_client (no external library needed)
; K1-Lightwave beat tracker now fully integrated

; Audio-reactive build with per-hop timing instrumentation
; Build: pio run -e esp32dev_audio_benchmark
; Adds ~2.2KB RAM, <0.02% CPU overhead for per-phase timing
[env:esp32dev_audio_benchmark]
extends = env:esp32dev_audio
build_flags =
	${env:esp32dev_audio.build_flags}
	-D FEATURE_AUDIO_BENCHMARK=1
	-I.pio/libdeps/esp32dev_audio/FastLED/src/third_party/cq_kernel

; Audio-reactive build with MabuTrace for Perfetto timeline visualization
; Build: pio run -e esp32dev_audio_trace
; Capture: Connect serial, send 'trace_dump' command, view at ui.perfetto.dev
; See: docs/debugging/MABUTRACE_GUIDE.md
[env:esp32dev_audio_trace]
extends = env:esp32dev_audio
build_flags =
	${env:esp32dev_audio.build_flags}
	-D FEATURE_MABUTRACE=1
	-I.pio/libdeps/esp32dev_audio/FastLED/src/third_party/cq_kernel
lib_deps =
	${env:esp32dev_audio.lib_deps}
	mabuware/mabutrace

; ESP32-S3-Zero (4MB Flash, 2MB PSRAM) - AP-ONLY MODE
; Compact build for Waveshare ESP32-S3-Zero or similar
; Hardware: ESP32-FH4R2, SPH0645 mic (GPIO 12/13/14), WS2812 LEDs (GPIO 4/5)
; NOTE: Runs in AP-only mode due to weak PCB antenna - connect to "LightwaveOS" AP
; Build: pio run -e esp32s3_zero
[env:esp32s3_zero]
extends = env:esp32dev_audio
board = esp32-s3-devkitc-1
board_build.partitions = partitions_4mb.csv
board_upload.flash_size = 4MB
board_build.flash_mode = dio
board_build.f_flash = 80000000L
board_build.psram_type = opi
board_build.arduino.memory_type = qio_qspi
build_flags =
	${env:esp32dev_audio.build_flags}
	-D BOARD_HAS_PSRAM
	-D PSRAM_SIZE=2097152
	-D LW_FORCE_AP_MODE=1
	-I.pio/libdeps/esp32s3_zero/FastLED/src/third_party/cq_kernel

; Native unit tests (no hardware required)
; Build: pio run -e native_test
; Run:   .pio/build/native_test/program
[env:native_test]
platform = native
build_src_filter =
	-<*>
	+<../test/test_native/*>
build_flags =
	-std=c++17
	-D NATIVE_BUILD=1
	-D LIGHTWAVEOS_V2=1
	-D NUM_LEDS=320
	-D CENTER_POINT=80
	-D FEATURE_MULTI_DEVICE=1
	-D FEATURE_AUDIO_SYNC=1
	-D LW_LOG_LEVEL=4
	-I test/test_native
	-I test/test_native/mocks
	-I src
	-I src/sync
test_framework = unity
test_build_src = no
lib_deps =
	throwtheswitch/Unity@^2.5.2

; Audio unit tests (native)
; Run: pio test -e native_test_audio
[env:native_test_audio]
platform = native
build_src_filter =
	-<*>
	+<audio/GoertzelAnalyzer.cpp>
	+<audio/tempo/TempoTracker.cpp>
build_flags =
	-std=c++17
	-D NATIVE_BUILD=1
	-D LIGHTWAVEOS_V2=1
	-D FEATURE_AUDIO_SYNC=1
	-I src
test_filter = test_audio
test_build_src = yes
test_framework = unity
lib_deps =
	throwtheswitch/Unity@^2.5.2

; Audio pipeline benchmark tests (native)
; Build: pio run -e native_audio_benchmark
; Run:   .pio/build/native_audio_benchmark/program
[env:native_audio_benchmark]
platform = native
build_src_filter =
	-<*>
	+<audio/GoertzelAnalyzer.cpp>
	+<audio/tempo/TempoTracker.cpp>
build_flags =
	-std=c++17
	-D NATIVE_BUILD=1
	-D LIGHTWAVEOS_V2=1
	-D FEATURE_AUDIO_SYNC=1
	-D FEATURE_AUDIO_BENCHMARK=1
	-I src
	-I test/test_audio
	-I test/test_native
test_filter = test_audio_benchmark
test_build_src = yes
test_framework = unity
lib_deps =
	throwtheswitch/Unity@^2.5.2

; K1 FFT Unit Tests (native)
; Run: pio test -e native_test_k1_fft
[env:native_test_k1_fft]
platform = native
build_src_filter =
	-<*>
	+<audio/k1/K1FFTAnalyzer.cpp>
	+<audio/k1/SpectralFlux.cpp>
build_flags =
	-std=c++17
	-D NATIVE_BUILD=1
	-D LIGHTWAVEOS_V2=1
	-I src
	-I src/audio/k1
	-I .pio/libdeps/native_test_k1_fft/FastLED/src/third_party/cq_kernel
build_unflags =
	-D FIXED_POINT
test_filter = test_k1_fft
test_build_src = yes
test_framework = unity
lib_deps =
	throwtheswitch/Unity@^2.5.2
	fastled/FastLED@3.10.0
