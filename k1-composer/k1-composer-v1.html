<html lang="en-GB"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>K1 Composer Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;460;500;520;560;600;640;700&amp;family=IBM+Plex+Mono:wght@400;500&amp;display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    <style>
      :root {
        --bg: #0c0d10;
        --surface: #16181d;
        --surface-raised: #1c1f26;
        --border: rgba(255,255,255,0.08);
        --border-subtle: rgba(255,255,255,0.05);
        --text: #ececef;
        --text-secondary: #8b8d98;
        --text-tertiary: #5c5e6a;
        --accent: #6e56cf;
        --accent-hover: #7c66d4;
        --accent-subtle: rgba(110,86,207,0.15);
        --danger: #e5484d;
        --danger-hover: #ec5d5e;
        --danger-subtle: rgba(229,72,77,0.12);
        --success: #30a46c;
        --success-subtle: rgba(48,164,108,0.12);
        --warning: #f5a623;
        --warning-subtle: rgba(245,166,35,0.12);
        --info: #3b82f6;
        --info-subtle: rgba(59,130,246,0.12);
        --radius: 12px;
        --radius-lg: 16px;
        --shadow: 0 1px 3px rgba(0,0,0,0.4), 0 8px 24px rgba(0,0,0,0.25);
        --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
        --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        --mono: 'IBM Plex Mono', 'Menlo', monospace;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: var(--font);
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
      }

      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }

      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 4px;
        background: rgba(255,255,255,0.08);
        border-radius: 2px;
        outline: none;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--accent);
        border: 2px solid var(--surface);
        box-shadow: 0 0 0 2px rgba(110,86,207,0.3);
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.15);
        box-shadow: 0 0 0 4px rgba(110,86,207,0.25);
      }
      input[type="range"]::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--accent);
        border: 2px solid var(--surface);
        cursor: pointer;
      }
      input[type="range"]:disabled {
        opacity: 0.35;
        cursor: not-allowed;
      }
      input[type="range"]:disabled::-webkit-slider-thumb {
        cursor: not-allowed;
        transform: none;
      }

      .code-glow { position: relative; }
      .code-glow::before {
        content: '';
        position: absolute;
        inset: -1px;
        border-radius: var(--radius-lg);
        background: linear-gradient(135deg, rgba(110,86,207,0.2), rgba(59,130,246,0.1), rgba(110,86,207,0.05));
        z-index: -1;
        opacity: 0.6;
      }

      .strip { display: flex; gap: 1px; height: 20px; }
      .strip span { flex: 1 1 0; border-radius: 1px; background: #2a2d35; transition: background 0.1s; }

      .algo-flow { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
      .algo-flow div {
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 8px 6px;
        text-align: center;
        font-weight: 560;
        font-size: 0.6875rem;
        background: var(--bg);
        color: var(--text-tertiary);
        transition: all 0.2s ease;
        font-family: var(--mono);
      }
      .algo-flow .is-active {
        background: var(--accent-subtle);
        border-color: var(--accent);
        color: var(--text);
        box-shadow: 0 0 12px rgba(110,86,207,0.15);
      }

      .speed-group {
        display: inline-flex;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
      }
      .speed-group button {
        border: none;
        border-right: 1px solid var(--border);
        border-radius: 0;
        padding: 5px 9px;
        font-size: 0.6875rem;
        font-family: var(--mono);
        min-height: 30px;
        background: var(--bg);
        color: var(--text-tertiary);
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .speed-group button:last-child { border-right: none; }
      .speed-group button.is-active {
        background: var(--accent);
        color: white;
      }
      .speed-group button:hover:not(.is-active) {
        background: var(--surface-raised);
        color: var(--text-secondary);
      }

      .telemetry-log {
        margin: 0;
        max-height: 260px;
        overflow: auto;
        background: var(--bg);
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
        padding: 0;
        font-family: var(--mono);
        font-size: 0.6875rem;
        line-height: 1.7;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .telemetry-log .feed-row {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 7px 12px;
        border-bottom: 1px solid var(--border-subtle);
        transition: background 0.1s ease;
      }
      .telemetry-log .feed-row:hover { background: rgba(255,255,255,0.02); }
      .telemetry-log .feed-row:last-child { border-bottom: none; }
      .telemetry-log .feed-ts {
        color: var(--text-tertiary);
        white-space: nowrap;
        flex-shrink: 0;
        font-size: 0.625rem;
        line-height: 1.8;
        opacity: 0.7;
      }
      .telemetry-log .feed-pill {
        display: inline-flex;
        align-items: center;
        padding: 1px 6px;
        border-radius: 4px;
        font-size: 0.5625rem;
        font-weight: 560;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        white-space: nowrap;
        flex-shrink: 0;
        line-height: 1.6;
      }
      .telemetry-log .feed-pill.pill-info { background: var(--info-subtle); color: var(--info); }
      .telemetry-log .feed-pill.pill-success { background: var(--success-subtle); color: var(--success); }
      .telemetry-log .feed-pill.pill-warning { background: var(--warning-subtle); color: var(--warning); }
      .telemetry-log .feed-pill.pill-error { background: var(--danger-subtle); color: var(--danger); }
      .telemetry-log .feed-pill.pill-default { background: rgba(255,255,255,0.05); color: var(--text-tertiary); }
      .telemetry-log .feed-msg {
        color: #7dd3fc;
        flex: 1;
        min-width: 0;
        word-break: break-all;
      }

      .kv-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
        font-family: var(--mono);
        font-size: 0.625rem;
      }
      .kv-grid div {
        border: 1px solid var(--border-subtle);
        border-radius: 4px;
        padding: 6px 8px;
        background: var(--bg);
        color: var(--text-tertiary);
        line-height: 1.4;
      }

      .slider-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .toast {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        max-width: min(420px, calc(100vw - 2rem));
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--surface-raised);
        box-shadow: var(--shadow);
        padding: 10px 14px;
        font-size: 0.75rem;
        color: var(--text);
        opacity: 0;
        transform: translateY(8px);
        pointer-events: none;
        transition: opacity 180ms ease, transform 180ms ease;
        z-index: 100;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .code-line {
        display: block;
        padding: 0 12px;
        border-left: 2px solid transparent;
        transition: background 0.15s ease, border-color 0.15s ease;
      }
      .code-line .keyword { color: #c084fc; }
      .code-line .fn { color: #60a5fa; }
      .code-line .string { color: #34d399; }
      .code-line .number { color: #fbbf24; }
      .code-line .comment { color: #4b5563; font-style: italic; }
      .code-line .op { color: #94a3b8; }
      .code-line .type { color: #f472b6; }
      .code-line .param { color: #a78bfa; }

      .btn {
        min-height: 30px;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 5px 10px;
        background: var(--surface-raised);
        color: var(--text-secondary);
        font-family: var(--font);
        font-weight: 520;
        font-size: 0.6875rem;
        cursor: pointer;
        transition: all 0.15s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
      }
      .btn:hover:not(:disabled) {
        background: rgba(255,255,255,0.06);
        color: var(--text);
      }
      .btn:disabled { opacity: 0.35; cursor: not-allowed; }
      .btn-accent {
        background: var(--accent);
        border-color: transparent;
        color: white;
        font-weight: 560;
      }
      .btn-accent:hover:not(:disabled) { background: var(--accent-hover); color: white; }
      .btn-danger {
        background: var(--danger);
        border-color: transparent;
        color: white;
        font-weight: 560;
      }
      .btn-danger:hover:not(:disabled) { background: var(--danger-hover); color: white; }
      .btn-ghost {
        background: transparent;
        border-color: transparent;
        color: var(--text-tertiary);
      }
      .btn-ghost:hover:not(:disabled) {
        background: rgba(255,255,255,0.04);
        color: var(--text-secondary);
      }
      .btn-icon {
        min-height: 28px;
        min-width: 28px;
        padding: 4px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: 1px solid transparent;
        color: var(--text-tertiary);
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .btn-icon:hover {
        background: rgba(255,255,255,0.06);
        border-color: var(--border);
        color: var(--text-secondary);
      }

      .panel {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: var(--surface);
        overflow: hidden;
      }
      .panel-header {
        padding: 10px 14px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.75rem;
        font-weight: 560;
      }
      .panel-header .panel-icon {
        display: flex;
        align-items: center;
        color: var(--text-tertiary);
      }
      .panel-badge {
        margin-left: auto;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 0.5625rem;
        font-weight: 560;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-family: var(--mono);
      }
      .panel-body { padding: 12px 14px; }

      .badge-status {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border-radius: 999px;
        padding: 3px 9px;
        font-size: 0.625rem;
        font-weight: 560;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-family: var(--mono);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }
      .badge-muted {
        background: rgba(255,255,255,0.06);
        color: var(--text-tertiary);
        border: 1px solid rgba(255,255,255,0.06);
      }
      .badge-success {
        background: rgba(48,164,108,0.1);
        color: var(--success);
        border: 1px solid rgba(48,164,108,0.15);
      }
      .badge-info {
        background: rgba(59,130,246,0.1);
        color: var(--info);
        border: 1px solid rgba(59,130,246,0.15);
      }
      .badge-warning {
        background: rgba(245,166,35,0.1);
        color: var(--warning);
        border: 1px solid rgba(245,166,35,0.15);
      }

      @keyframes execPulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(48,164,108,0.4); }
        50% { box-shadow: 0 0 0 4px rgba(48,164,108,0); }
      }
      .exec-dot-active { animation: execPulse 2s ease-in-out infinite; }

      .inspector-section {
        border-bottom: 1px solid var(--border-subtle);
        padding-bottom: 10px;
        margin-bottom: 10px;
      }
      .inspector-section:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
      .inspector-section-header {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        padding: 4px 0;
        margin-bottom: 8px;
        user-select: none;
      }
      .inspector-section-header:hover .inspector-section-title { color: var(--text); }
      .inspector-section-title {
        font-size: 0.5625rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: var(--text-tertiary);
        font-family: var(--mono);
        transition: color 0.15s;
      }
      .inspector-section-chevron {
        color: var(--text-tertiary);
        transition: transform 0.2s ease;
        flex-shrink: 0;
      }
      .inspector-section-chevron.collapsed { transform: rotate(-90deg); }
      .inspector-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 3px 0;
      }
      .inspector-row-label {
        font-size: 0.625rem;
        font-weight: 520;
        color: var(--text-secondary);
        min-width: 68px;
        flex-shrink: 0;
      }
      .inspector-row-value {
        font-family: var(--mono);
        color: var(--accent);
        font-weight: 500;
        font-size: 0.625rem;
        min-width: 28px;
        text-align: right;
        flex-shrink: 0;
      }
      .inspector-row-slider { flex: 1; min-width: 0; }

      .topbar-glass {
        background: rgba(22, 24, 29, 0.72);
        backdrop-filter: blur(20px) saturate(1.4);
        -webkit-backdrop-filter: blur(20px) saturate(1.4);
        border-bottom: 1px solid rgba(255,255,255,0.06);
      }
      .topbar-glass::after {
        content: '';
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 100%);
      }

      /* ── KPI Tiles ── */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }
      .kpi-tile {
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        padding: 10px 10px 8px;
        background: var(--bg);
        transition: border-color 0.15s ease, background 0.15s ease;
        position: relative;
        overflow: hidden;
      }
      .kpi-tile:hover {
        border-color: var(--border);
        background: rgba(255,255,255,0.02);
      }
      .kpi-tile-label {
        font-family: var(--mono);
        font-size: 0.5625rem;
        font-weight: 520;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-tertiary);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .kpi-tile-value {
        font-family: var(--mono);
        font-size: 1.125rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        color: var(--text);
        transition: color 0.2s ease;
        line-height: 1.2;
      }
      .kpi-tile-sub {
        font-family: var(--mono);
        font-size: 0.5625rem;
        color: var(--text-tertiary);
        margin-top: 2px;
      }
      .kpi-tile-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 2px;
        border-radius: 0 0 1px 0;
        transition: width 0.4s ease, background 0.3s ease;
      }

      /* ── Alert rows ── */
      .alert-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
        max-height: 170px;
        overflow-y: auto;
      }
      .alert-row {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 7px 10px;
        border-radius: 6px;
        border: 1px solid transparent;
        transition: background 0.15s ease, border-color 0.15s ease;
        font-size: 0.6875rem;
        line-height: 1.45;
      }
      .alert-row:hover { background: rgba(255,255,255,0.02); }
      .alert-row.alert-critical {
        background: var(--danger-subtle);
        border-color: rgba(229,72,77,0.18);
      }
      .alert-row.alert-critical:hover {
        background: rgba(229,72,77,0.16);
      }
      .alert-row.alert-warning {
        background: var(--warning-subtle);
        border-color: rgba(245,166,35,0.18);
      }
      .alert-row.alert-warning:hover {
        background: rgba(245,166,35,0.16);
      }
      .alert-row.alert-info {
        background: var(--info-subtle);
        border-color: rgba(59,130,246,0.15);
      }
      .alert-row.alert-info:hover {
        background: rgba(59,130,246,0.12);
      }
      .alert-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 5px;
      }
      .alert-dot-critical { background: var(--danger); }
      .alert-dot-warning { background: var(--warning); }
      .alert-dot-info { background: var(--info); }
      .alert-ts {
        font-family: var(--mono);
        font-size: 0.5625rem;
        color: var(--text-tertiary);
        white-space: nowrap;
        flex-shrink: 0;
        opacity: 0.7;
        margin-top: 1px;
      }
      .alert-msg {
        flex: 1;
        min-width: 0;
        color: var(--text-secondary);
      }
      .alert-msg strong {
        font-weight: 560;
        color: var(--text);
      }
      .alert-empty {
        padding: 16px 10px;
        text-align: center;
        font-size: 0.6875rem;
        color: var(--text-tertiary);
        font-family: var(--mono);
      }

      /* ── Responsive ── */
      @media (max-width: 1079px) and (min-width: 768px) {
        .main-grid {
          grid-template-columns: repeat(6, 1fr) !important;
          padding: 0 16px 16px !important;
          gap: 12px !important;
        }
        .code-panel { grid-column: 1 / -1 !important; min-height: 400px !important; }
        .preview-panel { grid-column: 1 / 4 !important; }
        .diag-panel { grid-column: 4 / 7 !important; }
        .timeline-panel { grid-column: 1 / 5 !important; }
        .tuner-panel { grid-column: 5 / 7 !important; }
        .tele-panel { grid-column: 1 / -1 !important; }
        .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      }

      @media (max-width: 767px) {
        .main-grid {
          grid-template-columns: 1fr !important;
          padding: 0 12px 12px !important;
          gap: 10px !important;
        }
        .topbar-inner { flex-direction: column; align-items: stretch !important; gap: 10px !important; }
        .topbar-controls { flex-wrap: wrap; }
        .code-panel, .preview-panel, .diag-panel, .timeline-panel, .tuner-panel, .tele-panel {
          grid-column: 1 / -1 !important;
        }
        .code-panel { min-height: 320px !important; }
        .slider-grid { grid-template-columns: 1fr; }
        .kv-grid { grid-template-columns: 1fr; }
        .kpi-grid { grid-template-columns: 1fr; }
        .algo-flow { grid-template-columns: repeat(2, 1fr); }
        .lease-meta { flex-direction: column; gap: 2px; }
        .topbar-right { flex-wrap: wrap; }
      }

      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.01ms !important;
          transition-duration: 0.01ms !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Bar -->
    <div class="topbar-glass" style="position:sticky;top:0;z-index:50;">
      <div style="display:flex;align-items:center;padding:6px 16px;border-bottom:1px solid rgba(255,255,255,0.04);gap:6px;position:relative;">
        <span style="width:10px;height:10px;border-radius:50%;background:#e5484d;opacity:0.8;flex-shrink:0;"></span>
        <span style="width:10px;height:10px;border-radius:50%;background:#f5a623;opacity:0.8;flex-shrink:0;"></span>
        <span style="width:10px;height:10px;border-radius:50%;background:#30a46c;opacity:0.8;flex-shrink:0;"></span>
        <div style="margin-left:10px;display:flex;align-items:center;gap:6px;">
          <span style="font-family:var(--mono);font-size:0.6875rem;color:var(--text-secondary);">k1-lightwave.pipeline</span>
          <span style="color:var(--text-tertiary);font-size:0.5rem;">•</span>
          <span style="font-size:0.625rem;color:var(--text-tertiary);">firmware v2</span>
        </div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:6px;">
          <span id="connectBadge" class="badge-status badge-muted">
            <span style="width:5px;height:5px;border-radius:50%;background:currentColor;"></span>Disconnected
          </span>
          <span id="leaseBadge" class="badge-status badge-muted">Observe</span>
        </div>
      </div>
      <div class="topbar-inner" style="max-width:1440px;margin:0 auto;padding:5px 16px;display:flex;align-items:center;gap:8px;position:relative;">
        <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
          <div style="width:26px;height:26px;background:var(--accent);border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.6875rem;letter-spacing:-0.05em;color:white;">K1</div>
          <h1 style="font-size:0.8125rem;font-weight:600;letter-spacing:-0.02em;line-height:1;">Lightwave Composer</h1>
        </div>
        <div style="width:1px;height:18px;background:rgba(255,255,255,0.08);flex-shrink:0;"></div>
        <label style="display:flex;align-items:center;gap:5px;flex-shrink:1;min-width:0;">
          <span style="font-size:0.5625rem;color:var(--text-tertiary);font-weight:520;white-space:nowrap;font-family:var(--mono);">host</span>
          <input id="hostInput" type="text" value="192.168.1.100" placeholder="lightwaveos.local" style="width:138px;border:1px solid var(--border);border-radius:5px;padding:4px 7px;font-family:var(--mono);font-size:0.6875rem;background:rgba(0,0,0,0.3);color:var(--text);outline:none;transition:border-color 0.15s;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
        </label>
        <div class="topbar-controls" style="display:flex;gap:3px;align-items:center;flex-shrink:0;">
          <button id="connectBtn" class="btn" style="padding:5px 9px;">
            <iconify-icon icon="solar:plug-circle-linear" width="13" style="stroke-width:1.5"></iconify-icon>Connect
          </button>
          <button id="acquireBtn" class="btn btn-accent" style="padding:5px 10px;">
            <iconify-icon icon="solar:lock-keyhole-linear" width="13" style="stroke-width:1.5"></iconify-icon>Take Control
          </button>
          <button id="releaseBtn" class="btn" style="padding:5px 8px;">Release</button>
          <button id="reacquireBtn" class="btn" style="padding:5px 8px;">Reacquire</button>
          <button id="statusBtn" class="btn-icon">
            <iconify-icon icon="solar:refresh-linear" width="14" style="stroke-width:1.5"></iconify-icon>
          </button>
          <div style="width:1px;height:18px;background:rgba(255,255,255,0.06);margin:0 2px;flex-shrink:0;"></div>
          <button id="emergencyBtn" class="btn btn-danger" style="padding:5px 9px;">
            <iconify-icon icon="solar:danger-triangle-linear" width="13" style="stroke-width:1.5"></iconify-icon>E-Stop
          </button>
        </div>
        <div class="topbar-right" style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-shrink:0;">
          <span id="ownerBadge" style="font-family:var(--mono);font-size:0.5625rem;color:var(--text-tertiary);">owner: n/a</span>
          <div class="lease-meta" style="display:flex;gap:8px;font-family:var(--mono);font-size:0.5625rem;color:var(--text-tertiary);">
            <span id="leaseId">leaseId: -</span>
            <span id="leaseTtl">remaining: -</span>
            <span id="hbState">heartbeat: idle</span>
          </div>
        </div>
      </div>
    </div>

    <section class="toolbar" style="display:none;"></section>

    <!-- Main Grid -->
    <main class="main-grid" style="display:grid;grid-template-columns:repeat(12,1fr);gap:24px 16px;max-width:1440px;margin:0 auto;padding:20px 24px 24px;">

      <!-- CODE VISUALISER (7 cols) -->
      <section class="panel code-panel code-glow" style="grid-column:1/8;grid-row:1/3;min-height:520px;display:flex;flex-direction:column;border-radius:var(--radius-lg);">
        <div style="padding:0;border-bottom:1px solid var(--border);">
          <div style="display:flex;align-items:center;padding:10px 14px;gap:10px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <iconify-icon icon="solar:code-linear" width="15" style="color:var(--accent);stroke-width:1.5"></iconify-icon>
              <h2 style="font-size:0.8125rem;font-weight:600;letter-spacing:-0.02em;">Live Code Visualiser</h2>
            </div>
            <span style="font-family:var(--mono);font-size:0.5625rem;color:var(--text-tertiary);background:rgba(255,255,255,0.04);padding:2px 6px;border-radius:4px;">TypeScript</span>
            <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
              <span style="font-size:0.5625rem;color:var(--text-tertiary);font-family:var(--mono);" id="lineCount">55 lines</span>
              <span style="color:var(--text-tertiary);font-size:0.5rem;">•</span>
              <span style="font-size:0.5625rem;color:var(--success);font-family:var(--mono);">No errors</span>
            </div>
          </div>
        </div>
        <div id="codeVisualiser" style="flex:1;overflow:auto;padding:12px 0;font-family:var(--mono);font-size:0.75rem;line-height:1.75;background:var(--bg);position:relative;">
          <div style="display:flex;">
            <div id="lineNumbers" style="width:44px;text-align:right;padding-right:12px;color:var(--text-tertiary);font-size:0.6875rem;user-select:none;flex-shrink:0;opacity:0.5;"></div>
            <pre id="codeContent" style="flex:1;margin:0;padding-right:16px;color:var(--text-secondary);overflow-x:auto;white-space:pre;"></pre>
          </div>
        </div>
        <div style="padding:8px 14px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;background:var(--surface);">
          <div id="execIndicator" style="width:7px;height:7px;border-radius:50%;background:var(--text-tertiary);transition:background 0.3s;flex-shrink:0;"></div>
          <span id="execStatus" style="font-size:0.6875rem;font-weight:520;color:var(--text-secondary);font-family:var(--mono);">Idle · No pipeline active</span>
          <span style="margin-left:auto;font-family:var(--mono);font-size:0.625rem;color:var(--text-tertiary);" id="execPhase">phase: input</span>
        </div>
      </section>

      <!-- LED PREVIEW (5 cols) -->
      <section class="panel preview-panel" style="grid-column:8/13;grid-row:1/2;">
        <div class="panel-header">
          <span class="panel-icon"><iconify-icon icon="solar:lightbulb-bolt-linear" width="14" style="color:var(--warning);stroke-width:1.5"></iconify-icon></span>
          <span>LED Preview</span>
          <span id="streamBadge" class="panel-badge badge-info" style="font-family:var(--mono);">
            <span style="width:4px;height:4px;border-radius:50%;background:currentColor;"></span>stream
          </span>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:10px;">
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
              <span style="font-size:0.625rem;font-weight:520;color:var(--text-secondary);">Strip A</span>
              <span style="font-size:0.5625rem;font-family:var(--mono);color:var(--text-tertiary);">64 LEDs</span>
            </div>
            <div class="strip" id="stripA" aria-label="Strip A preview" style="height:22px;border-radius:3px;overflow:hidden;"></div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
              <span style="font-size:0.625rem;font-weight:520;color:var(--text-secondary);">Strip B</span>
              <span style="font-size:0.5625rem;font-family:var(--mono);color:var(--text-tertiary);">64 LEDs</span>
            </div>
            <div class="strip" id="stripB" aria-label="Strip B preview" style="height:22px;border-radius:3px;overflow:hidden;"></div>
          </div>
          <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg);">
            <div style="font-size:0.5625rem;font-weight:520;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:5px;font-family:var(--mono);">Centre Origin</div>
            <div id="centreOriginVis" style="display:flex;height:14px;gap:1px;justify-content:center;"></div>
          </div>
        </div>
      </section>

      <!-- DIAGNOSTICS + HEALTH (5 cols, row 2) -->
      <section class="panel diag-panel" style="grid-column:8/13;grid-row:2/3;display:flex;flex-direction:column;">
        <div class="panel-header">
          <span class="panel-icon"><iconify-icon icon="solar:graph-new-linear" width="14" style="color:var(--success);stroke-width:1.5"></iconify-icon></span>
          <span>Stream Health</span>
          <span id="diagBadge" class="panel-badge badge-success" style="font-family:var(--mono);">
            <span style="width:4px;height:4px;border-radius:50%;background:currentColor;"></span>healthy
          </span>
        </div>
        <div class="panel-body" style="display:flex;flex-direction:column;gap:12px;flex:1;">

          <!-- KPI Tiles -->
          <div>
            <div style="font-size:0.5625rem;font-weight:520;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;font-family:var(--mono);">KPIs</div>
            <div class="kpi-grid" id="kpiGrid">
              <div class="kpi-tile" data-kpi="queueP95">
                <div class="kpi-tile-bar" style="width:0%;background:var(--success);"></div>
                <div class="kpi-tile-label">
                  <iconify-icon icon="solar:layers-linear" width="10" style="stroke-width:1.5"></iconify-icon>
                  Queue p95
                </div>
                <div class="kpi-tile-value" id="kpiQueueP95">0</div>
                <div class="kpi-tile-sub">buffered msgs</div>
              </div>
              <div class="kpi-tile" data-kpi="cadence">
                <div class="kpi-tile-bar" style="width:0%;background:var(--info);"></div>
                <div class="kpi-tile-label">
                  <iconify-icon icon="solar:pulse-2-linear" width="10" style="stroke-width:1.5"></iconify-icon>
                  Cadence
                </div>
                <div class="kpi-tile-value" id="kpiCadence">0<span style="font-size:0.625rem;font-weight:500;color:var(--text-tertiary);margin-left:2px;">Hz</span></div>
                <div class="kpi-tile-sub">msg/sec</div>
              </div>
              <div class="kpi-tile" data-kpi="jitter">
                <div class="kpi-tile-bar" style="width:0%;background:var(--warning);"></div>
                <div class="kpi-tile-label">
                  <iconify-icon icon="solar:wave-square-linear" width="10" style="stroke-width:1.5"></iconify-icon>
                  Jitter
                </div>
                <div class="kpi-tile-value" id="kpiJitter">0<span style="font-size:0.625rem;font-weight:500;color:var(--text-tertiary);margin-left:2px;">ms</span></div>
                <div class="kpi-tile-sub">stddev</div>
              </div>
              <div class="kpi-tile" data-kpi="dropRatio">
                <div class="kpi-tile-bar" style="width:0%;background:var(--danger);"></div>
                <div class="kpi-tile-label">
                  <iconify-icon icon="solar:trash-bin-minimalistic-linear" width="10" style="stroke-width:1.5"></iconify-icon>
                  Drop Ratio
                </div>
                <div class="kpi-tile-value" id="kpiDropRatio">0<span style="font-size:0.625rem;font-weight:500;color:var(--text-tertiary);margin-left:2px;">%</span></div>
                <div class="kpi-tile-sub"><span id="kpiDrop10s">10s: 0%</span> · <span id="kpiDrop60s">60s: 0%</span></div>
              </div>
            </div>
          </div>

          <!-- Algorithm Flow -->
          <div>
            <div style="font-size:0.5625rem;font-weight:520;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;font-family:var(--mono);">Pipeline</div>
            <div class="algo-flow" id="algoFlow">
              <div data-node="input">Input</div>
              <div data-node="mapping">Mapping</div>
              <div data-node="modulation">Modulate</div>
              <div data-node="render">Render</div>
              <div data-node="post">PostFX</div>
              <div data-node="output">Output</div>
            </div>
          </div>

          <!-- Alerts -->
          <div style="flex:1;display:flex;flex-direction:column;min-height:0;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
              <div style="font-size:0.5625rem;font-weight:520;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.06em;font-family:var(--mono);display:flex;align-items:center;gap:5px;">
                <iconify-icon icon="solar:bell-linear" width="10" style="stroke-width:1.5;color:var(--text-tertiary);"></iconify-icon>
                Alerts
              </div>
              <span id="alertCount" class="badge-status badge-muted" style="font-size:0.5rem;padding:1px 6px;">0</span>
            </div>
            <div class="alert-list" id="alertList">
              <div class="alert-empty">
                <iconify-icon icon="solar:check-circle-linear" width="16" style="stroke-width:1.5;color:var(--success);display:block;margin:0 auto 4px;"></iconify-icon>
                No active alerts
              </div>
            </div>
          </div>

          <!-- Lease State (collapsed) -->
          <div>
            <div style="display:flex;align-items:center;gap:5px;cursor:pointer;margin-bottom:6px;" id="leaseToggle">
              <iconify-icon id="leaseChevron" icon="solar:alt-arrow-right-linear" width="10" style="color:var(--text-tertiary);stroke-width:1.5;transition:transform 0.2s;"></iconify-icon>
              <span style="font-size:0.5625rem;font-weight:520;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.06em;font-family:var(--mono);">Lease State</span>
            </div>
            <div id="leaseStateWrapper" style="display:none;">
              <div id="leaseStateBlock" class="kv-grid"></div>
            </div>
          </div>

        </div>
      </section>

      <!-- TIMELINE (8 cols) -->
      <section class="panel timeline-panel" style="grid-column:1/9;">
        <div class="panel-header">
          <span class="panel-icon"><iconify-icon icon="solar:play-linear" width="14" style="color:var(--accent);stroke-width:1.5"></iconify-icon></span>
          <span>Execution Timeline</span>
        </div>
        <div class="panel-body">
          <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
            <button id="playBtn" class="btn btn-accent" style="padding:6px 14px;">
              <iconify-icon icon="solar:play-linear" width="13" style="stroke-width:1.5"></iconify-icon>Run
            </button>
            <button id="pauseBtn" class="btn" style="padding:6px 14px;">
              <iconify-icon icon="solar:pause-linear" width="13" style="stroke-width:1.5"></iconify-icon>Pause
            </button>
            <button id="resetBtn" class="btn" style="padding:6px 14px;">
              <iconify-icon icon="solar:restart-linear" width="13" style="stroke-width:1.5"></iconify-icon>Reset
            </button>
            <div style="width:1px;height:20px;background:var(--border);margin:0 4px;"></div>
            <div class="speed-group" role="group" aria-label="playback speed">
              <button data-speed="0.25">0.25×</button>
              <button data-speed="0.5">0.5×</button>
              <button data-speed="1" class="is-active">1×</button>
              <button data-speed="2">2×</button>
            </div>
          </div>
          <div>
            <input id="timeline" type="range" min="0" max="1000" value="0">
            <div style="display:flex;justify-content:space-between;color:var(--text-tertiary);font-size:0.625rem;margin-top:6px;font-family:var(--mono);">
              <span>Input</span><span>Mapping</span><span>Render</span><span>Output</span>
            </div>
          </div>
        </div>
      </section>

      <!-- PARAMETER TUNER (4 cols) -->
      <section class="panel tuner-panel" style="grid-column:9/13;">
        <div class="panel-header">
          <span class="panel-icon"><iconify-icon icon="solar:tuning-2-linear" width="14" style="color:var(--warning);stroke-width:1.5"></iconify-icon></span>
          <span>Inspector</span>
          <span class="panel-badge badge-muted" style="font-family:var(--mono);">parameters</span>
        </div>
        <div class="panel-body" style="padding:10px 14px;">
          <div id="tunerGrid"></div>
        </div>
      </section>

      <!-- TELEMETRY -->
      <section class="panel tele-panel" style="grid-column:1/13;">
        <div class="panel-header" style="cursor:pointer;" onclick="var c=document.getElementById('teleContent');var i=document.getElementById('teleChevron');if(c.style.display==='none'){c.style.display='block';i.style.transform='rotate(0deg)';}else{c.style.display='none';i.style.transform='rotate(-90deg)';}">
          <span class="panel-icon"><iconify-icon icon="solar:document-text-linear" width="14" style="color:var(--info);stroke-width:1.5"></iconify-icon></span>
          <span>Event Trace</span>
          <span class="panel-badge badge-muted" style="font-family:var(--mono);">console</span>
          <iconify-icon id="teleChevron" icon="solar:alt-arrow-down-linear" width="12" style="color:var(--text-tertiary);stroke-width:1.5;margin-left:auto;transition:transform 0.2s;"></iconify-icon>
        </div>
        <div id="teleContent" style="padding:10px 14px 14px;">
          <div id="telemetryLog" class="telemetry-log"></div>
        </div>
      </section>

    </main>

    <section class="card lease-card" style="display:none;"><h2>Control Lease</h2></section>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script type="module" id="__inlined_app_js__">
const ui = {
  hostInput: document.getElementById("hostInput"),
  connectBtn: document.getElementById("connectBtn"),
  acquireBtn: document.getElementById("acquireBtn"),
  releaseBtn: document.getElementById("releaseBtn"),
  reacquireBtn: document.getElementById("reacquireBtn"),
  statusBtn: document.getElementById("statusBtn"),
  emergencyBtn: document.getElementById("emergencyBtn"),
  connectBadge: document.getElementById("connectBadge"),
  leaseBadge: document.getElementById("leaseBadge"),
  ownerBadge: document.getElementById("ownerBadge"),
  leaseId: document.getElementById("leaseId"),
  leaseTtl: document.getElementById("leaseTtl"),
  hbState: document.getElementById("hbState"),
  timeline: document.getElementById("timeline"),
  playBtn: document.getElementById("playBtn"),
  pauseBtn: document.getElementById("pauseBtn"),
  resetBtn: document.getElementById("resetBtn"),
  speedButtons: Array.from(document.querySelectorAll(".speed-group button")),
  leaseStateBlock: document.getElementById("leaseStateBlock"),
  stripA: document.getElementById("stripA"),
  stripB: document.getElementById("stripB"),
  algoFlow: document.getElementById("algoFlow"),
  tunerGrid: document.getElementById("tunerGrid"),
  telemetryLog: document.getElementById("telemetryLog"),
  toast: document.getElementById("toast"),
  codeContent: document.getElementById("codeContent"),
  lineNumbers: document.getElementById("lineNumbers"),
  execIndicator: document.getElementById("execIndicator"),
  execStatus: document.getElementById("execStatus"),
  execPhase: document.getElementById("execPhase"),
  centreOriginVis: document.getElementById("centreOriginVis"),
  // New health UI
  kpiQueueP95: document.getElementById("kpiQueueP95"),
  kpiCadence: document.getElementById("kpiCadence"),
  kpiJitter: document.getElementById("kpiJitter"),
  kpiDropRatio: document.getElementById("kpiDropRatio"),
  kpiDrop10s: document.getElementById("kpiDrop10s"),
  kpiDrop60s: document.getElementById("kpiDrop60s"),
  kpiGrid: document.getElementById("kpiGrid"),
  alertList: document.getElementById("alertList"),
  alertCount: document.getElementById("alertCount"),
  diagBadge: document.getElementById("diagBadge"),
  leaseToggle: document.getElementById("leaseToggle"),
  leaseStateWrapper: document.getElementById("leaseStateWrapper"),
  leaseChevron: document.getElementById("leaseChevron"),
};

// Lease toggle
ui.leaseToggle.addEventListener("click", () => {
  const w = ui.leaseStateWrapper;
  const open = w.style.display !== "none";
  w.style.display = open ? "none" : "block";
  ui.leaseChevron.style.transform = open ? "rotate(0deg)" : "rotate(90deg)";
});

const state = {
  host: ui.hostInput.value.trim(),
  ws: null,
  connected: false,
  clientName: "K1 Composer Dashboard",
  clientInstanceId: crypto.randomUUID(),
  lease: {
    active: false, leaseId: "", leaseToken: "",
    ownerClientName: "", ownerInstanceId: "",
    remainingMs: 0, ttlMs: 5000, heartbeatIntervalMs: 1000, scope: "global",
  },
  heartbeatTimer: null, statusPollTimer: null, leaseCountdownTimer: null,
  pending: new Map(), reqSeq: 0,
  transport: { playing: false, speed: 1, timeline: 0, raf: null, lastTs: 0 },
  eventBuffer: [], codeActiveLine: 0,
  // Health tracking
  health: {
    msgTimestamps: [],
    jitterSamples: [],
    lastMsgTime: 0,
    dropped10s: 0,
    total10s: 0,
    dropped60s: 0,
    total60s: 0,
    queueP95: 0,
  },
  alerts: [],
};

const paramConfig = [
  { key: "speed", label: "Speed", min: 1, max: 50, value: 20, group: "Motion" },
  { key: "intensity", label: "Intensity", min: 0, max: 255, value: 128, group: "Motion" },
  { key: "saturation", label: "Saturation", min: 0, max: 255, value: 160, group: "Color" },
  { key: "complexity", label: "Complexity", min: 0, max: 255, value: 140, group: "Color" },
  { key: "variation", label: "Variation", min: 0, max: 255, value: 90, group: "Output" },
  { key: "brightness", label: "Brightness", min: 0, max: 255, value: 180, group: "Output" },
];

const SENSITIVE_TELEMETRY_KEYS = new Set([
  "leaseToken", "x-control-lease", "x-control-lease-id", "authorization", "apiKey",
]);

const sampleCode = [
  { text: '// K1 Lightwave Pipeline — render loop', cls: 'comment' },
  { text: '' },
  { text: '<span class="keyword">import</span> { LedController, Pipeline } <span class="keyword">from</span> <span class="string">"@k1/core"</span>;' },
  { text: '<span class="keyword">import</span> { SemanticMapper } <span class="keyword">from</span> <span class="string">"@k1/mapping"</span>;' },
  { text: '' },
  { text: '<span class="keyword">const</span> <span class="fn">config</span> <span class="op">=</span> {' },
  { text: '  stripCount<span class="op">:</span> <span class="number">2</span>,' },
  { text: '  ledsPerStrip<span class="op">:</span> <span class="number">64</span>,' },
  { text: '  origin<span class="op">:</span> <span class="string">"centre"</span>,' },
  { text: '  fps<span class="op">:</span> <span class="number">60</span>,' },
  { text: '};' },
  { text: '' },
  { text: '<span class="keyword">const</span> pipeline <span class="op">=</span> <span class="keyword">new</span> <span class="fn">Pipeline</span>(config);' },
  { text: '' },
  { text: '<span class="comment">// Phase 1: Input acquisition</span>' },
  { text: 'pipeline.<span class="fn">addStage</span>(<span class="string">"input"</span>, (ctx) <span class="op">=></span> {' },
  { text: '  ctx.audio <span class="op">=</span> <span class="fn">captureAudio</span>(ctx.bufferSize);' },
  { text: '  ctx.params <span class="op">=</span> <span class="fn">readParameters</span>();' },
  { text: '  <span class="keyword">return</span> ctx;' },
  { text: '});' },
  { text: '' },
  { text: '<span class="comment">// Phase 2: Semantic mapping</span>' },
  { text: 'pipeline.<span class="fn">addStage</span>(<span class="string">"mapping"</span>, (ctx) <span class="op">=></span> {' },
  { text: '  <span class="keyword">const</span> mapper <span class="op">=</span> <span class="keyword">new</span> <span class="fn">SemanticMapper</span>(ctx.params);' },
  { text: '  ctx.mapped <span class="op">=</span> mapper.<span class="fn">transform</span>(ctx.audio);' },
  { text: '  ctx.energy <span class="op">=</span> mapper.<span class="fn">computeEnergy</span>();' },
  { text: '  <span class="keyword">return</span> ctx;' },
  { text: '});' },
  { text: '' },
  { text: '<span class="comment">// Phase 3: Modulation + effects</span>' },
  { text: 'pipeline.<span class="fn">addStage</span>(<span class="string">"modulation"</span>, (ctx) <span class="op">=></span> {' },
  { text: '  <span class="keyword">const</span> t <span class="op">=</span> performance.<span class="fn">now</span>() <span class="op">*</span> <span class="number">0.001</span>;' },
  { text: '  ctx.hue <span class="op">=</span> (ctx.mapped.hue <span class="op">+</span> Math.<span class="fn">sin</span>(t) <span class="op">*</span> <span class="number">30</span>) <span class="op">%</span> <span class="number">360</span>;' },
  { text: '  ctx.intensity <span class="op">=</span> ctx.energy <span class="op">*</span> ctx.params.intensity;' },
  { text: '  <span class="keyword">return</span> ctx;' },
  { text: '});' },
  { text: '' },
  { text: '<span class="comment">// Phase 4: Render to LED buffer</span>' },
  { text: 'pipeline.<span class="fn">addStage</span>(<span class="string">"render"</span>, (ctx) <span class="op">=></span> {' },
  { text: '  <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="op">=</span> <span class="number">0</span>; i <span class="op"><</span> config.ledsPerStrip; i<span class="op">++</span>) {' },
  { text: '    <span class="keyword">const</span> d <span class="op">=</span> Math.<span class="fn">abs</span>(i <span class="op">-</span> <span class="number">32</span>) <span class="op">/</span> <span class="number">32</span>; <span class="comment">// centre origin</span>' },
  { text: '    <span class="keyword">const</span> h <span class="op">=</span> (ctx.hue <span class="op">+</span> i <span class="op">*</span> <span class="number">0.9</span>) <span class="op">%</span> <span class="number">360</span>;' },
  { text: '    <span class="keyword">const</span> l <span class="op">=</span> <span class="number">55</span> <span class="op">-</span> d <span class="op">*</span> <span class="number">35</span>;' },
  { text: '    ctx.buffer[i] <span class="op">=</span> <span class="fn">hsl</span>(h, <span class="number">70</span>, l);' },
  { text: '  }' },
  { text: '  <span class="keyword">return</span> ctx;' },
  { text: '});' },
  { text: '' },
  { text: '<span class="comment">// Phase 5: PostFX + output</span>' },
  { text: 'pipeline.<span class="fn">addStage</span>(<span class="string">"output"</span>, (ctx) <span class="op">=></span> {' },
  { text: '  <span class="fn">applyGamma</span>(ctx.buffer, <span class="number">2.2</span>);' },
  { text: '  controller.<span class="fn">pushFrame</span>(ctx.buffer);' },
  { text: '  <span class="keyword">return</span> ctx;' },
  { text: '});' },
  { text: '' },
  { text: 'pipeline.<span class="fn">start</span>();' },
];

const phaseLines = {
  input: [15, 16, 17, 18, 19],
  mapping: [22, 23, 24, 25, 26, 27],
  modulation: [30, 31, 32, 33, 34, 35],
  render: [38, 39, 40, 41, 42, 43, 44, 45, 46],
  post: [49, 50, 51, 52, 53],
  output: [49, 50, 51, 52, 53],
};

function renderCode() {
  let linesHtml = '';
  let numsHtml = '';
  sampleCode.forEach((line, i) => {
    const num = i + 1;
    numsHtml += `<div style="height:1.75em;line-height:1.75em;">${num}</div>`;
    linesHtml += `<span class="code-line" data-line="${num}" style="display:block;height:1.75em;line-height:1.75em;">${line.text || ' '}</span>`;
  });
  ui.lineNumbers.innerHTML = numsHtml;
  ui.codeContent.innerHTML = linesHtml;
}

function highlightCodePhase(phase) {
  const lines = phaseLines[phase] || [];
  const allLines = ui.codeContent.querySelectorAll('.code-line');
  allLines.forEach(el => {
    const ln = parseInt(el.dataset.line);
    if (lines.includes(ln)) {
      el.style.background = 'rgba(110,86,207,0.08)';
      el.style.borderLeftColor = 'var(--accent)';
      el.style.color = 'var(--text)';
    } else {
      el.style.background = 'transparent';
      el.style.borderLeftColor = 'transparent';
      el.style.color = '';
    }
  });
  const phaseNames = { input: 'Input Acquisition', mapping: 'Semantic Mapping', modulation: 'Modulation', render: 'LED Render', post: 'PostFX', output: 'LED Output' };
  ui.execPhase.textContent = `phase: ${phase}`;
  if (state.transport.playing) {
    ui.execIndicator.style.background = 'var(--success)';
    ui.execStatus.textContent = `Running · ${phaseNames[phase] || phase}`;
    ui.execIndicator.classList.add('exec-dot-active');
  } else {
    ui.execIndicator.style.background = 'var(--text-tertiary)';
    ui.execStatus.textContent = `Idle · ${phaseNames[phase] || phase}`;
    ui.execIndicator.classList.remove('exec-dot-active');
  }
}

function renderCentreOriginVis(hue) {
  const container = ui.centreOriginVis;
  if (container.childElementCount === 0) {
    for (let i = 0; i < 32; i++) {
      const led = document.createElement('span');
      led.style.cssText = 'flex:1;border-radius:1px;background:#2a2d35;transition:background 0.1s;height:100%;';
      container.appendChild(led);
    }
  }
  const leds = Array.from(container.children);
  const half = leds.length / 2;
  leds.forEach((led, i) => {
    const d = Math.abs(i - half) / half;
    const l = 60 - d * 40;
    const s = 75 + (1 - d) * 20;
    const h = (hue + Math.abs(i - half) * 2) % 360;
    led.style.background = `hsl(${h} ${s}% ${l}%)`;
  });
}

function makeReqId(prefix = "req") { state.reqSeq += 1; return `${prefix}-${state.reqSeq}-${Date.now()}`; }

function toast(message) {
  ui.toast.textContent = message;
  ui.toast.classList.add("show");
  window.clearTimeout(toast.timer);
  toast.timer = window.setTimeout(() => ui.toast.classList.remove("show"), 2200);
}

function sanitiseTelemetry(value) {
  if (Array.isArray(value)) return value.map(item => sanitiseTelemetry(item));
  if (value && typeof value === "object") {
    const out = {};
    Object.entries(value).forEach(([key, nested]) => {
      if (SENSITIVE_TELEMETRY_KEYS.has(key) || SENSITIVE_TELEMETRY_KEYS.has(key.toLowerCase())) out[key] = "[REDACTED]";
      else out[key] = sanitiseTelemetry(nested);
    });
    return out;
  }
  return value;
}

function eventSeverity(event) {
  if (/error|fail|lost|stop/i.test(event)) return 'pill-error';
  if (/warn|timeout/i.test(event)) return 'pill-warning';
  if (/acquire|heartbeat|ok|connect|init|start/i.test(event)) return 'pill-success';
  if (/release|change|update|speed/i.test(event)) return 'pill-info';
  return 'pill-default';
}

function eventLabel(event) {
  const parts = event.split('.');
  return parts[parts.length - 1] || event;
}

function logEvent(event, payload = {}) {
  const safePayload = sanitiseTelemetry(payload);
  const now = new Date();
  const ts = now.toISOString().slice(11, 23);
  const msgStr = JSON.stringify(safePayload);
  state.eventBuffer.unshift({ ts, event, msg: msgStr });
  state.eventBuffer = state.eventBuffer.slice(0, 120);
  const container = ui.telemetryLog;
  container.innerHTML = '';
  state.eventBuffer.forEach(entry => {
    const row = document.createElement('div');
    row.className = 'feed-row';
    const tsEl = document.createElement('span');
    tsEl.className = 'feed-ts';
    tsEl.textContent = entry.ts;
    const pillEl = document.createElement('span');
    pillEl.className = `feed-pill ${eventSeverity(entry.event)}`;
    pillEl.textContent = eventLabel(entry.event);
    const msgEl = document.createElement('span');
    msgEl.className = 'feed-msg';
    msgEl.textContent = entry.msg === '{}' ? '' : entry.msg;
    row.appendChild(tsEl);
    row.appendChild(pillEl);
    row.appendChild(msgEl);
    container.appendChild(row);
  });

  // Feed alerts from events
  processAlertFromEvent(event, safePayload, ts);
}

/* ── ALERTS SYSTEM ── */
function pushAlert(tier, msg) {
  const ts = new Date().toISOString().slice(11, 19);
  state.alerts.unshift({ tier, msg, ts, id: Date.now() });
  state.alerts = state.alerts.slice(0, 30);
  renderAlerts();
}

function processAlertFromEvent(event, payload, ts) {
  // Critical
  if (/disconnect|lost|stop/i.test(event)) {
    pushAlert("critical", event.replace(/\./g, ' '));
  }
  // Warning
  else if (/timeout|fail|heartbeat_failed/i.test(event)) {
    pushAlert("warning", event.replace(/\./g, ' '));
  }
  // Info: lease changes, reconnects
  else if (/lease\.(acquired|released|changed)|ws\.connect/i.test(event)) {
    pushAlert("info", event.replace(/\./g, ' '));
  }
}

function renderAlerts() {
  const list = ui.alertList;
  const critCount = state.alerts.filter(a => a.tier === "critical").length;
  const warnCount = state.alerts.filter(a => a.tier === "warning").length;

  // Update count badge
  const total = state.alerts.length;
  ui.alertCount.textContent = String(total);
  if (critCount > 0) {
    ui.alertCount.className = 'badge-status';
    ui.alertCount.style.cssText = 'font-size:0.5rem;padding:1px 6px;background:var(--danger-subtle);color:var(--danger);border:1px solid rgba(229,72,77,0.18);';
  } else if (warnCount > 0) {
    ui.alertCount.className = 'badge-status';
    ui.alertCount.style.cssText = 'font-size:0.5rem;padding:1px 6px;background:var(--warning-subtle);color:var(--warning);border:1px solid rgba(245,166,35,0.18);';
  } else {
    ui.alertCount.className = 'badge-status badge-muted';
    ui.alertCount.style.cssText = 'font-size:0.5rem;padding:1px 6px;';
  }

  if (total === 0) {
    list.innerHTML = '<div class="alert-empty"><iconify-icon icon="solar:check-circle-linear" width="16" style="stroke-width:1.5;color:var(--success);display:block;margin:0 auto 4px;"></iconify-icon>No active alerts</div>';
    return;
  }

  list.innerHTML = '';
  state.alerts.slice(0, 20).forEach(a => {
    const row = document.createElement('div');
    row.className = `alert-row alert-${a.tier}`;

    const dot = document.createElement('span');
    dot.className = `alert-dot alert-dot-${a.tier}`;

    const tsEl = document.createElement('span');
    tsEl.className = 'alert-ts';
    tsEl.textContent = a.ts;

    const msgEl = document.createElement('span');
    msgEl.className = 'alert-msg';
    msgEl.textContent = a.msg;

    row.appendChild(dot);
    row.appendChild(tsEl);
    row.appendChild(msgEl);
    list.appendChild(row);
  });
}

/* ── KPI UPDATES ── */
function updateKPI(id, value, barPct, barColor) {
  const tile = ui.kpiGrid.querySelector(`[data-kpi="${id}"]`);
  if (!tile) return;
  const bar = tile.querySelector('.kpi-tile-bar');
  if (bar) {
    bar.style.width = Math.min(100, Math.max(0, barPct)) + '%';
    if (barColor) bar.style.background = barColor;
  }
}

function computeAndRenderHealth() {
  const h = state.health;
  const now = performance.now();

  // Simulated values when not connected — show zeros
  if (!state.connected) {
    ui.kpiQueueP95.innerHTML = '0';
    ui.kpiCadence.innerHTML = '0<span style="font-size:0.625rem;font-weight:500;color:var(--text-tertiary);margin-left:2px;">Hz</span>';
    ui.kpiJitter.innerHTML = '0<span style="font-size:0.625rem;font-weight:500;color:var(--text-tertiary);margin-left:2px;">ms</span>';
    ui.kpiDropRatio.innerHTML = '0<span style="font-size:0.625rem;font-weight:500;color:var(--text-tertiary);margin-left:2px;">%</span>';
    ui.kpiDrop10s.textContent = '10s: 0%';
    ui.kpiDrop60s.textContent = '60s: 0%';
    updateKPI('queueP95', 0, 0, 'var(--success)');
    updateKPI('cadence', 0, 0, 'var(--info)');
    updateKPI('jitter', 0, 0, 'var(--warning)');
    updateKPI('dropRatio', 0, 0, 'var(--danger)');
    updateDiagBadge('idle');
    return;
  }

  // When connected, derive from ws state
  const ws = state.ws;
  const queueP95 = ws ? ws.bufferedAmount : 0;
  const cadenceHz = h.msgTimestamps.length;
  const jitterMs = h.jitterSamples.length > 1 ? stddev(h.jitterSamples) : 0;
  const drop10 = h.total10s > 0 ? (h.dropped10s / h.total10s * 100) : 0;
  const drop60 = h.total60s > 0 ? (h.dropped60s / h.total60s * 100) : 0;
  const dropRatio = Math.max(drop10, drop60);

  // Determine severity colors for bars
  const qColor = queueP95 > 5000 ? 'var(--danger)' : queueP95 > 1000 ? 'var(--warning)' : 'var(--success)';
  const jColor = jitterMs > 200 ? 'var(--danger)' : jitterMs > 80 ? 'var(--warning)' : 'var(--success)';
  const dColor = dropRatio > 10 ? 'var(--danger)' : dropRatio > 2 ? 'var(--warning)' : 'var(--success)';

  ui.kpiQueueP95.innerHTML = String(queueP95);
  ui.kpiCadence.innerHTML = `${cadenceHz}<span style="font-size:0.625rem;font-weight:500;color:var(--text-tertiary);margin-left:2px;">Hz</span>`;
  ui.kpiJitter.innerHTML = `${jitterMs.toFixed(1)}<span style="font-size:0.625rem;font-weight:500;color:var(--text-tertiary);margin-left:2px;">ms</span>`;
  ui.kpiDropRatio.innerHTML = `${dropRatio.toFixed(1)}<span style="font-size:0.625rem;font-weight:500;color:var(--text-tertiary);margin-left:2px;">%</span>`;
  ui.kpiDrop10s.textContent = `10s: ${drop10.toFixed(1)}%`;
  ui.kpiDrop60s.textContent = `60s: ${drop60.toFixed(1)}%`;

  updateKPI('queueP95', queueP95, Math.min(100, queueP95 / 100), qColor);
  updateKPI('cadence', cadenceHz, Math.min(100, cadenceHz / 60 * 100), 'var(--info)');
  updateKPI('jitter', jitterMs, Math.min(100, jitterMs / 300 * 100), jColor);
  updateKPI('dropRatio', dropRatio, Math.min(100, dropRatio / 20 * 100), dColor);

  // Apply value color to the tile value elements
  ui.kpiQueueP95.style.color = qColor === 'var(--success)' ? 'var(--text)' : qColor === 'var(--warning)' ? 'var(--warning)' : 'var(--danger)';
  ui.kpiJitter.style.color = jColor === 'var(--success)' ? 'var(--text)' : jColor === 'var(--warning)' ? 'var(--warning)' : 'var(--danger)';
  ui.kpiDropRatio.style.color = dColor === 'var(--success)' ? 'var(--text)' : dColor === 'var(--warning)' ? 'var(--warning)' : 'var(--danger)';

  // Overall health badge
  if (dropRatio > 10 || queueP95 > 5000 || jitterMs > 200) {
    updateDiagBadge('critical');
  } else if (dropRatio > 2 || queueP95 > 1000 || jitterMs > 80) {
    updateDiagBadge('degraded');
  } else {
    updateDiagBadge('healthy');
  }

  // Auto-generate alerts for threshold breaches
  if (dropRatio > 10 && !state._alertedDropCritical) {
    pushAlert('critical', `Extreme drop ratio: ${dropRatio.toFixed(1)}%`);
    state._alertedDropCritical = true;
  } else if (dropRatio <= 10) { state._alertedDropCritical = false; }

  if (jitterMs > 200 && !state._alertedJitterSpike) {
    pushAlert('warning', `Jitter spike: ${jitterMs.toFixed(1)}ms stddev`);
    state._alertedJitterSpike = true;
  } else if (jitterMs <= 200) { state._alertedJitterSpike = false; }

  if (queueP95 > 1000 && !state._alertedQueueRising) {
    pushAlert('warning', `bufferedAmount p95 rising: ${queueP95}`);
    state._alertedQueueRising = true;
  } else if (queueP95 <= 1000) { state._alertedQueueRising = false; }
}

function updateDiagBadge(status) {
  const badge = ui.diagBadge;
  if (status === 'critical') {
    badge.innerHTML = '<span style="width:4px;height:4px;border-radius:50%;background:currentColor;"></span>critical';
    badge.className = 'panel-badge';
    badge.style.cssText = 'font-family:var(--mono);background:var(--danger-subtle);color:var(--danger);border:1px solid rgba(229,72,77,0.18);';
  } else if (status === 'degraded') {
    badge.innerHTML = '<span style="width:4px;height:4px;border-radius:50%;background:currentColor;"></span>degraded';
    badge.className = 'panel-badge';
    badge.style.cssText = 'font-family:var(--mono);background:var(--warning-subtle);color:var(--warning);border:1px solid rgba(245,166,35,0.18);';
  } else if (status === 'idle') {
    badge.innerHTML = '<span style="width:4px;height:4px;border-radius:50%;background:currentColor;"></span>idle';
    badge.className = 'panel-badge badge-muted';
    badge.style.cssText = 'font-family:var(--mono);';
  } else {
    badge.innerHTML = '<span style="width:4px;height:4px;border-radius:50%;background:currentColor;"></span>healthy';
    badge.className = 'panel-badge badge-success';
    badge.style.cssText = 'font-family:var(--mono);';
  }
}

function stddev(arr) {
  if (arr.length < 2) return 0;
  const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
  const sqDiffs = arr.map(v => (v - mean) ** 2);
  return Math.sqrt(sqDiffs.reduce((a, b) => a + b, 0) / arr.length);
}

function recordMessageTiming() {
  const now = performance.now();
  const h = state.health;
  if (h.lastMsgTime > 0) {
    const delta = now - h.lastMsgTime;
    h.jitterSamples.push(delta);
    if (h.jitterSamples.length > 60) h.jitterSamples.shift();
  }
  h.lastMsgTime = now;
  h.msgTimestamps.push(now);
  // Keep only last 1s for cadence
  const cutoff = now - 1000;
  h.msgTimestamps = h.msgTimestamps.filter(t => t > cutoff);
}

// Periodic health refresh
setInterval(computeAndRenderHealth, 500);

function setConnectionBadge(connected) {
  if (connected) {
    ui.connectBadge.innerHTML = '<span style="width:5px;height:5px;border-radius:50%;background:#30a46c;"></span>Connected';
    ui.connectBadge.className = 'badge-status badge-success';
  } else {
    ui.connectBadge.innerHTML = '<span style="width:5px;height:5px;border-radius:50%;background:var(--text-tertiary);"></span>Disconnected';
    ui.connectBadge.className = 'badge-status badge-muted';
  }
}

function setLeaseModeBadge(mode) {
  if (mode === "exclusive") {
    ui.leaseBadge.textContent = "Exclusive";
    ui.leaseBadge.className = 'badge-status badge-success';
  } else if (mode === "locked") {
    ui.leaseBadge.textContent = "Locked";
    ui.leaseBadge.className = 'badge-status badge-warning';
  } else {
    ui.leaseBadge.textContent = "Observe";
    ui.leaseBadge.className = 'badge-status badge-muted';
  }
}

function canMutate() {
  return state.connected && state.lease.active && state.lease.ownerInstanceId === state.clientInstanceId;
}

function updateControls() {
  const exclusive = canMutate();
  ui.acquireBtn.disabled = !state.connected || exclusive;
  ui.releaseBtn.disabled = !exclusive;
  ui.reacquireBtn.disabled = !state.connected;
  ui.emergencyBtn.disabled = !exclusive;
  const sliders = ui.tunerGrid.querySelectorAll("input[type=range]");
  sliders.forEach(el => { el.disabled = !exclusive; });
  if (!state.connected) { setLeaseModeBadge("muted"); return; }
  if (!state.lease.active) setLeaseModeBadge("muted");
  else if (exclusive) setLeaseModeBadge("exclusive");
  else setLeaseModeBadge("locked");
}

function updateLeaseMeta() {
  ui.leaseId.textContent = `leaseId: ${state.lease.leaseId || "-"}`;
  ui.leaseTtl.textContent = `remaining: ${Math.max(0, Math.floor(state.lease.remainingMs || 0))}ms`;
  ui.ownerBadge.textContent = `owner: ${state.lease.ownerClientName || "n/a"}`;
  const pairs = [
    ["active", String(Boolean(state.lease.active))],
    ["scope", state.lease.scope || "global"],
    ["ownerClientName", state.lease.ownerClientName || "-"],
    ["ownerInstanceId", state.lease.ownerInstanceId || "-"],
    ["ownerWsClientId", String(state.lease.ownerWsClientId ?? "-")],
    ["ttlMs", String(state.lease.ttlMs || 0)],
    ["heartbeatIntervalMs", String(state.lease.heartbeatIntervalMs || 0)],
    ["remainingMs", String(Math.max(0, Math.floor(state.lease.remainingMs || 0)))],
  ];
  ui.leaseStateBlock.innerHTML = "";
  pairs.forEach(([k, v]) => {
    const cell = document.createElement("div");
    cell.textContent = `${k}: ${v}`;
    ui.leaseStateBlock.appendChild(cell);
  });
  updateControls();
}

function updateLeaseFromPayload(payload = {}, includeToken = false) {
  if (typeof payload.active === "boolean") state.lease.active = payload.active;
  if (payload.leaseId !== undefined) state.lease.leaseId = payload.leaseId || "";
  if (includeToken && payload.leaseToken) state.lease.leaseToken = payload.leaseToken;
  if (payload.scope) state.lease.scope = payload.scope;
  if (payload.ownerClientName !== undefined) state.lease.ownerClientName = payload.ownerClientName || "";
  if (payload.ownerInstanceId !== undefined) state.lease.ownerInstanceId = payload.ownerInstanceId || "";
  if (payload.ownerWsClientId !== undefined) state.lease.ownerWsClientId = payload.ownerWsClientId;
  if (payload.remainingMs !== undefined) state.lease.remainingMs = payload.remainingMs;
  if (payload.ttlMs !== undefined) state.lease.ttlMs = payload.ttlMs;
  if (payload.heartbeatIntervalMs !== undefined) state.lease.heartbeatIntervalMs = payload.heartbeatIntervalMs;
  updateLeaseMeta();
}

function startLeaseCountdown() {
  window.clearInterval(state.leaseCountdownTimer);
  state.leaseCountdownTimer = window.setInterval(() => {
    if (state.lease.remainingMs > 0) { state.lease.remainingMs -= 100; updateLeaseMeta(); }
  }, 100);
}

function stopLeaseCountdown() { window.clearInterval(state.leaseCountdownTimer); }

function stopHeartbeat() {
  window.clearInterval(state.heartbeatTimer);
  state.heartbeatTimer = null;
  ui.hbState.textContent = "heartbeat: idle";
}

async function startHeartbeat() {
  stopHeartbeat();
  if (!canMutate()) return;
  const tick = async () => {
    if (!canMutate()) { stopHeartbeat(); return; }
    try {
      const result = await sendWsCommand("control.heartbeat", { leaseId: state.lease.leaseId, leaseToken: state.lease.leaseToken });
      ui.hbState.textContent = "heartbeat: ok";
      updateLeaseFromPayload(result, false);
      logEvent("control.lease.heartbeat", result);
    } catch (error) {
      ui.hbState.textContent = "heartbeat: failed";
      toast(`Lease heartbeat failed: ${error.message}`);
      logEvent("control.lease.heartbeat_failed", { message: error.message });
    }
  };
  await tick();
  state.heartbeatTimer = window.setInterval(tick, Math.max(300, state.lease.heartbeatIntervalMs || 1000));
}

function cleanupWs() {
  if (state.ws) { state.ws.onopen = null; state.ws.onclose = null; state.ws.onerror = null; state.ws.onmessage = null; state.ws.close(); }
  state.ws = null; state.connected = false;
  setConnectionBadge(false); stopHeartbeat(); stopLeaseCountdown();
  state.pending.clear(); updateControls();
}

function wsUrl() { const host = state.host || "lightwaveos.local"; return `ws://${host}/ws`; }
function apiUrl(path) { const host = state.host || "lightwaveos.local"; return `http://${host}${path}`; }

function connect() {
  cleanupWs();
  state.host = ui.hostInput.value.trim();
  const ws = new WebSocket(wsUrl());
  state.ws = ws;
  ws.onopen = async () => {
    state.connected = true; setConnectionBadge(true); updateControls();
    toast("Connected to device"); logEvent("ws.connect", { host: state.host });
    startLeaseCountdown(); await refreshLeaseStatus(); startStatusPolling();
  };
  ws.onclose = () => {
    const hadLease = state.lease.active; cleanupWs();
    state.lease.active = false; state.lease.leaseToken = ""; state.lease.leaseId = "";
    updateLeaseMeta();
    pushAlert('critical', 'WebSocket disconnected');
    if (hadLease) { toast("Lease lost: websocket disconnected"); logEvent("control.lease.lost", { reason: "ws_disconnected" }); }
  };
  ws.onerror = () => { logEvent("ws.error", {}); };
  ws.onmessage = (event) => {
    recordMessageTiming();
    let msg; try { msg = JSON.parse(event.data); } catch { return; }
    if (msg.requestId && state.pending.has(msg.requestId)) {
      const pending = state.pending.get(msg.requestId); state.pending.delete(msg.requestId);
      if (msg.success === false) pending.reject(new Error(msg.error?.message || msg.error?.code || "Request failed"));
      else pending.resolve(msg.data ?? msg);
      return;
    }
    handleUnsolicitedMessage(msg);
  };
}

function handleUnsolicitedMessage(msg) {
  if (msg.type === "control.stateChanged" && msg.data) {
    updateLeaseFromPayload(msg.data, false);
    logEvent(`control.lease.${msg.event || "changed"}`, msg.data);
    if (!canMutate()) stopHeartbeat(); return;
  }
  if (msg.type === "status") { applyStatusFrame(msg); return; }
  if (msg.type === "error") {
    logEvent("ws.error", msg.error || {});
    if (msg.error?.code === "CONTROL_LOCKED") toast(`Locked by ${msg.error.ownerClientName || "another client"}`);
  }
}

function sendWsCommand(type, payload = {}) {
  if (!state.ws || state.ws.readyState !== WebSocket.OPEN) return Promise.reject(new Error("WebSocket not connected"));
  const requestId = makeReqId(type.replace(/\W/g, "_"));
  const body = { type, requestId, ...payload };
  return new Promise((resolve, reject) => {
    state.pending.set(requestId, { resolve, reject });
    state.ws.send(JSON.stringify(body));
    window.setTimeout(() => { if (state.pending.has(requestId)) { state.pending.delete(requestId); reject(new Error(`Timeout waiting for ${type}`)); } }, 3000);
  });
}

async function fetchJson(path, options = {}) {
  const headers = { "Content-Type": "application/json", ...(options.headers || {}) };
  const response = await fetch(apiUrl(path), { ...options, headers });
  const payload = await response.json().catch(() => ({}));
  if (!response.ok || payload.success === false) { const message = payload?.error?.message || `HTTP ${response.status}`; throw new Error(message); }
  return payload;
}

async function fetchMutating(path, body) {
  const headers = {};
  if (state.lease.active) {
    if (!state.lease.leaseToken) throw new Error("No lease token in memory");
    headers["X-Control-Lease"] = state.lease.leaseToken;
    if (state.lease.leaseId) headers["X-Control-Lease-Id"] = state.lease.leaseId;
  }
  return fetchJson(path, { method: "POST", headers, body: JSON.stringify(body) });
}

async function refreshLeaseStatus() {
  try { const byWs = state.connected ? await sendWsCommand("control.status") : null; if (byWs) { updateLeaseFromPayload(byWs, false); return; } } catch {}
  try { const rest = await fetchJson("/api/v1/control/status"); updateLeaseFromPayload(rest.data || {}, false); } catch (error) { logEvent("control.status.fetch_failed", { message: error.message }); }
}

async function acquireLease() {
  const result = await sendWsCommand("control.acquire", { clientName: state.clientName, clientInstanceId: state.clientInstanceId, scope: "global" });
  updateLeaseFromPayload(result, true); toast("Exclusive control acquired"); logEvent("control.lease.acquired", result);
  await startHeartbeat();
}

async function releaseLease(reason = "user_release") {
  if (!state.lease.leaseId || !state.lease.leaseToken) return;
  const result = await sendWsCommand("control.release", { leaseId: state.lease.leaseId, leaseToken: state.lease.leaseToken, reason });
  state.lease.active = false; state.lease.leaseToken = ""; state.lease.leaseId = "";
  updateLeaseMeta(); stopHeartbeat(); toast("Control lease released"); logEvent("control.lease.released", result);
}

async function emergencyStop() {
  await fetchMutating("/api/v1/parameters", { brightness: 0 });
  toast("Emergency stop: brightness set to 0"); logEvent("control.emergency_stop", {});
}

function applyStatusFrame(status) {
  if (status.controlLease) updateLeaseFromPayload(status.controlLease, false);
  const phase = derivePhase(status); highlightAlgorithmPhase(phase); updateStripPreview(status);
}

function derivePhase(status) {
  const t = Number(ui.timeline.value) / 1000;
  if (status?.type === "status" && status.audioSyncMode === "external") return "mapping";
  if (t < 0.2) return "input";
  if (t < 0.4) return "mapping";
  if (t < 0.6) return "modulation";
  if (t < 0.8) return "render";
  return "output";
}

function highlightAlgorithmPhase(name) {
  const nodes = ui.algoFlow.querySelectorAll("[data-node]");
  nodes.forEach(el => { el.classList.toggle("is-active", el.dataset.node === name); });
  highlightCodePhase(name);
}

function updateStripPreview(status = {}) {
  const base = Number(status.hue || state.transport.timeline / 4) % 360;
  paintStrip(ui.stripA, base, false);
  paintStrip(ui.stripB, base + 40, true);
  renderCentreOriginVis(base);
}

function paintStrip(container, hue, reverse) {
  if (container.childElementCount === 0) {
    for (let i = 0; i < 64; i++) { const led = document.createElement("span"); container.appendChild(led); }
  }
  const leds = Array.from(container.children);
  leds.forEach((led, idx) => {
    const t = reverse ? leds.length - idx - 1 : idx;
    const d = Math.abs(t - leds.length / 2) / (leds.length / 2);
    const l = 55 - d * 35;
    const s = 70 + (1 - d) * 25;
    const h = (hue + t * 0.9) % 360;
    led.style.background = `hsl(${h} ${s}% ${l}%)`;
  });
}

function createTuner() {
  const groups = {};
  paramConfig.forEach(cfg => {
    if (!groups[cfg.group]) groups[cfg.group] = [];
    groups[cfg.group].push(cfg);
  });
  const groupIcons = {
    "Motion": "solar:play-circle-linear",
    "Color": "solar:pallete-2-linear",
    "Output": "solar:monitor-linear",
  };
  Object.entries(groups).forEach(([groupName, params]) => {
    const section = document.createElement("div");
    section.className = "inspector-section";
    const header = document.createElement("div");
    header.className = "inspector-section-header";
    const chevron = document.createElement("iconify-icon");
    chevron.setAttribute("icon", "solar:alt-arrow-down-linear");
    chevron.setAttribute("width", "10");
    chevron.style.cssText = "stroke-width:1.5;";
    chevron.className = "inspector-section-chevron";
    const icon = document.createElement("iconify-icon");
    icon.setAttribute("icon", groupIcons[groupName] || "solar:settings-linear");
    icon.setAttribute("width", "12");
    icon.style.cssText = "color:var(--text-tertiary);stroke-width:1.5;";
    const title = document.createElement("span");
    title.className = "inspector-section-title";
    title.textContent = groupName;
    header.appendChild(chevron);
    header.appendChild(icon);
    header.appendChild(title);
    section.appendChild(header);
    const content = document.createElement("div");
    content.style.cssText = "display:flex;flex-direction:column;gap:6px;";
    params.forEach(cfg => {
      const row = document.createElement("div");
      row.className = "inspector-row";
      const label = document.createElement("span");
      label.className = "inspector-row-label";
      label.textContent = cfg.label;
      const slider = document.createElement("input");
      slider.type = "range";
      slider.min = String(cfg.min);
      slider.max = String(cfg.max);
      slider.value = String(cfg.value);
      slider.disabled = true;
      slider.className = "inspector-row-slider";
      const value = document.createElement("span");
      value.className = "inspector-row-value";
      value.textContent = String(cfg.value);
      slider.addEventListener("input", () => { value.textContent = slider.value; });
      slider.addEventListener("change", async () => {
        if (!canMutate()) return;
        try {
          const payload = { [cfg.key]: Number(slider.value) };
          await fetchMutating("/api/v1/parameters", payload);
          logEvent("parameter.update", payload);
        } catch (error) { toast(error.message); }
      });
      row.appendChild(label);
      row.appendChild(slider);
      row.appendChild(value);
      content.appendChild(row);
    });
    section.appendChild(content);
    header.addEventListener("click", () => {
      const isHidden = content.style.display === "none";
      content.style.display = isHidden ? "flex" : "none";
      chevron.classList.toggle("collapsed", !isHidden);
    });
    ui.tunerGrid.appendChild(section);
  });
}

function transportTick(ts) {
  if (!state.transport.playing) { state.transport.raf = null; state.transport.lastTs = 0; return; }
  if (!state.transport.lastTs) state.transport.lastTs = ts;
  const dt = ts - state.transport.lastTs;
  state.transport.lastTs = ts;
  state.transport.timeline = (state.transport.timeline + dt * 0.08 * state.transport.speed) % 1000;
  ui.timeline.value = String(Math.floor(state.transport.timeline));
  highlightAlgorithmPhase(derivePhase({}));
  updateStripPreview({});
  state.transport.raf = requestAnimationFrame(transportTick);
}

function playTimeline() {
  if (state.transport.playing) return;
  state.transport.playing = true;
  state.transport.raf = requestAnimationFrame(transportTick);
}

function pauseTimeline() {
  state.transport.playing = false;
  if (state.transport.raf) { cancelAnimationFrame(state.transport.raf); state.transport.raf = null; }
  state.transport.lastTs = 0;
}

function resetTimeline() {
  state.transport.timeline = 0; ui.timeline.value = "0";
  highlightAlgorithmPhase("input"); updateStripPreview({ hue: 0 });
}

function startStatusPolling() {
  window.clearInterval(state.statusPollTimer);
  state.statusPollTimer = window.setInterval(async () => { await refreshLeaseStatus(); }, 1500);
}

function bindEvents() {
  ui.connectBtn.addEventListener("click", connect);
  ui.statusBtn.addEventListener("click", () => refreshLeaseStatus());
  ui.acquireBtn.addEventListener("click", async () => {
    try { await acquireLease(); } catch (error) { toast(error.message); logEvent("control.lease.acquire_failed", { message: error.message }); }
  });
  ui.releaseBtn.addEventListener("click", async () => {
    try { await releaseLease("user_release"); } catch (error) { toast(error.message); logEvent("control.lease.release_failed", { message: error.message }); }
  });
  ui.reacquireBtn.addEventListener("click", async () => {
    try { await acquireLease(); } catch (error) { toast(error.message); logEvent("control.lease.reacquire_failed", { message: error.message }); }
  });
  ui.emergencyBtn.addEventListener("click", async () => {
    try { await emergencyStop(); } catch (error) { toast(error.message); logEvent("control.emergency_stop_failed", { message: error.message }); }
  });
  ui.playBtn.addEventListener("click", playTimeline);
  ui.pauseBtn.addEventListener("click", pauseTimeline);
  ui.resetBtn.addEventListener("click", resetTimeline);
  ui.speedButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const speed = Number(btn.dataset.speed || "1"); state.transport.speed = speed;
      ui.speedButtons.forEach(b => b.classList.toggle("is-active", b === btn));
      logEvent("timeline.speed", { speed });
    });
  });
  ui.timeline.addEventListener("input", () => {
    state.transport.timeline = Number(ui.timeline.value);
    highlightAlgorithmPhase(derivePhase({})); updateStripPreview({});
  });
  window.addEventListener("beforeunload", async () => {
    window.clearInterval(state.statusPollTimer);
    if (canMutate()) { try { await releaseLease("window_unload"); } catch {} }
    cleanupWs();
  });
}

function init() {
  createTuner(); updateLeaseMeta();
  updateStripPreview({ hue: 220 }); highlightAlgorithmPhase("input");
  renderCode(); highlightCodePhase("input");
  bindEvents();
  computeAndRenderHealth();
  renderAlerts();
  logEvent("dashboard.init", { clientInstanceId: state.clientInstanceId });
}

init();
    </script>
  
</body></html>