{
  "project": "Lightwave Ledstrip",
  "branchName": "ralph/api-authentication",
  "description": "Complete API Authentication system with NVS persistence, key management, and web UI",
  "userStories": [
    {
      "id": "US-001",
      "title": "Enable FEATURE_API_AUTH and verify builds",
      "description": "As a developer, I need FEATURE_API_AUTH enabled by default in the wifi build environment so authentication is active.",
      "acceptanceCriteria": [
        "Add -D FEATURE_API_AUTH=1 to esp32dev_audio_esv11 build_flags in platformio.ini",
        "Add -D API_KEY=\\\"LW-DEFAULT-KEY-CHANGE-ME\\\" as default placeholder",
        "pio run -e esp32dev_audio_esv11 compiles without errors",
        "pio run -e esp32dev_audio_esv11 compiles without errors (auth disabled)",
        "No new compiler warnings introduced"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Completed: Added esp32dev_audio_esv11 env with -D FEATURE_API_AUTH=1 -D API_KEY=\"LW-DEFAULT-KEY-CHANGE-ME\". Both builds compile cleanly."
    },
    {
      "id": "US-002",
      "title": "Create ApiKeyManager for NVS persistence",
      "description": "As a developer, I need API keys stored in NVS so they persist across reboots and can be changed at runtime.",
      "acceptanceCriteria": [
        "Create src/network/ApiKeyManager.h with getKey(), setKey(), generateKey(), clearKey() methods",
        "Create src/network/ApiKeyManager.cpp implementing NVS read/write",
        "Key stored in NVS namespace 'auth' with key 'api_key'",
        "generateKey() creates 32-char alphanumeric random key",
        "Falls back to compile-time API_KEY if NVS is empty",
        "pio run -e esp32dev_audio_esv11 compiles"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Completed: ApiKeyManager.h/cpp with NVS persistence in 'auth' namespace, key 'api_key'. generateKey() creates LW-XXXX-XXXX-... format (37 chars). Falls back to compile-time API_KEY. Includes constant-time key comparison."
    },
    {
      "id": "US-003",
      "title": "Integrate ApiKeyManager into WebServer",
      "description": "As a developer, I need WebServer to use ApiKeyManager instead of compile-time constant.",
      "acceptanceCriteria": [
        "WebServer constructor initializes ApiKeyManager",
        "checkAPIKey() reads from ApiKeyManager.getKey() not NetworkConfig::API_KEY_VALUE",
        "WebSocket auth handler reads from ApiKeyManager.getKey()",
        "pio run -e esp32dev_audio_esv11 compiles",
        "Existing auth behavior unchanged when NVS empty"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Completed: WebServer.h includes ApiKeyManager member (m_apiKeyManager). WebServer::begin() calls m_apiKeyManager.begin(). checkAPIKey() and WS auth use m_apiKeyManager.validateKey() with constant-time comparison."
    },
    {
      "id": "US-004",
      "title": "Add REST endpoint for key management",
      "description": "As an admin, I want REST endpoints to view, rotate, and clear API keys.",
      "acceptanceCriteria": [
        "POST /api/v1/auth/rotate generates new key and returns it (requires current valid key)",
        "DELETE /api/v1/auth/key clears NVS key, reverts to compile-time default (requires valid key)",
        "GET /api/v1/auth/status returns {enabled: bool, keyConfigured: bool} (public endpoint)",
        "All key-modifying endpoints require valid X-API-Key header",
        "pio run -e esp32dev_audio_esv11 compiles"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Completed: AuthHandlers.h/cpp implements all three endpoints. V1ApiRoutes.cpp registers routes with checkAPIKey for rotate/clear, public for status. Friend class access to m_apiKeyManager."
    },
    {
      "id": "US-005",
      "title": "Add failed authentication rate limiting",
      "description": "As a security measure, I need rate limiting on failed auth attempts to prevent brute force attacks.",
      "acceptanceCriteria": [
        "Track failed auth attempts per IP in RateLimiter or new AuthRateLimiter",
        "After 5 failed attempts in 60 seconds, block IP for 5 minutes",
        "Return 429 Too Many Requests with Retry-After header when blocked",
        "Successful auth resets the failure counter for that IP",
        "pio run -e esp32dev_audio_esv11 compiles"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Completed: Created AuthRateLimiter class in src/network/webserver/AuthRateLimiter.h. Integrated into WebServer checkAPIKey() for REST and WebSocket auth. Uses 5 attempts/60sec window with 5-minute block. Returns 429 with Retry-After header. Successful auth resets failure counter."
    },
    {
      "id": "US-006",
      "title": "Add WebSocket auth commands for key management",
      "description": "As a dashboard user, I want WebSocket commands for key management to match REST capabilities.",
      "acceptanceCriteria": [
        "Add WsAuthCommands.h/cpp in src/network/webserver/ws/",
        "Command 'auth.rotate' generates new key (requires authenticated client)",
        "Command 'auth.status' returns enabled/configured status",
        "Register commands in WsCommandRouter",
        "pio run -e esp32dev_audio_esv11 compiles"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Completed: WsAuthCommands.h/cpp with auth.status (public) and auth.rotate (requires auth) commands. WebServer.h added isClientAuthenticated() and getApiKeyManager() methods. Commands registered with FEATURE_API_AUTH guards."
    },
    {
      "id": "US-007",
      "title": "Add authentication section to web dashboard",
      "description": "As a user, I want to manage API authentication from the web dashboard.",
      "acceptanceCriteria": [
        "Add 'Security' section to settings page in data/index.html",
        "Show current auth status (enabled/disabled, key configured)",
        "Add 'Rotate Key' button that calls auth.rotate and displays new key once",
        "Add input field for entering API key on initial connection",
        "Store API key in localStorage for subsequent connections",
        "pio run -e esp32dev_audio_esv11 compiles",
        "UI renders correctly in browser"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Completed: Security section added to index.html with auth status badges, API key input with show/hide toggle, key save/clear buttons, and Rotate Key button. app.js updated with auth state management, localStorage persistence (lightwaveApiKey), WebSocket handlers for auth.status/auth/auth.rotate, and automatic authentication on connection when key is stored."
    },
    {
      "id": "US-008",
      "title": "Update documentation for API authentication",
      "description": "As a developer, I need documentation on how to use and configure API authentication.",
      "acceptanceCriteria": [
        "Add authentication section to docs/api/API_V1.md",
        "Document X-API-Key header requirement",
        "Document WebSocket auth message flow",
        "Document key rotation and management endpoints",
        "Document rate limiting behavior",
        "pio run -e esp32dev_audio_esv11 compiles"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Completed: Added comprehensive Authentication section to docs/api/api-v1.md including: enabling authentication, REST API authentication with X-API-Key header, WebSocket auth flow, key management endpoints (auth/status, auth/rotate, auth/key), auth rate limiting (5 attempts/60s, 5min block), and WebSocket authentication commands (auth.status, auth, auth.rotate). Documentation version updated to 1.2.0."
    }
  ]
}
