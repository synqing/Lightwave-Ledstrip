## Codebase Patterns
- NVS persistence uses Preferences library (see WiFiCredentialManager for pattern)
- REST responses use ApiResponse:: helpers
- WebSocket commands go in src/network/webserver/ws/Ws*Commands.cpp
- Rate limiting uses RateLimiter class
- Logging uses LW_LOGI, LW_LOGW, LW_LOGE macros from utils/Log.h
---

# Ralph Progress Log
Started: 2025-01-24
Branch: ralph/api-authentication
Feature: API Authentication with NVS persistence and web UI
---

## 2025-01-24 - US-001
- Added `esp32dev_wifi` environment to platformio.ini
- Enabled FEATURE_API_AUTH=1 with default key placeholder
- Files changed: firmware/v2/platformio.ini
- **Learnings for future iterations:**
  - platformio.ini uses extends= to inherit from base environment
  - FastLED include path needs `-I.pio/libdeps/<env>/FastLED/src/third_party/cq_kernel` per environment
  - wifi_credentials.ini provides WiFi credentials separately (gitignored)
---

## 2025-01-24 - US-002
- Created ApiKeyManager.h/cpp with NVS persistence
- Methods: getKey(), setKey(), generateKey(), clearKey(), validateKey(), hasCustomKey()
- NVS namespace 'auth' with key 'api_key'
- generateKey() creates LW-XXXX-XXXX-XXXX-XXXX-XXXX-XXXX-XXXX format (37 chars)
- Falls back to compile-time API_KEY if NVS is empty
- Files changed: firmware/v2/src/network/ApiKeyManager.h, ApiKeyManager.cpp
- **Learnings for future iterations:**
  - NVS pattern: Preferences.begin(namespace, false), getString/putString, end()
  - Use esp_random() for secure random number generation
  - Constant-time comparison prevents timing attacks: XOR all bytes, check result == 0
  - Cache NVS values in memory to avoid repeated reads
  - Pattern: FEATURE_WEB_SERVER && FEATURE_API_AUTH for conditional compilation
---

## 2025-01-24 - US-003
- Integrated ApiKeyManager into WebServer
- WebServer.h: Added #include "ApiKeyManager.h" and m_apiKeyManager member
- WebServer.cpp: Initialize m_apiKeyManager.begin() in WebServer::begin()
- checkAPIKey(): Now uses m_apiKeyManager.getKey() and validateKey()
- WebSocket auth: Lambda uses m_apiKeyManager.validateKey() instead of strcmp
- Files changed: firmware/v2/src/network/WebServer.h, WebServer.cpp
- **Learnings for future iterations:**
  - The WsGateway auth lambda captures `this` - m_apiKeyManager is accessible
  - validateKey() does constant-time comparison to prevent timing attacks
  - When NVS is empty, ApiKeyManager automatically falls back to compile-time key
  - Both REST and WebSocket use same ApiKeyManager instance for consistency
---

## 2025-01-24 - US-004
- REST endpoints for key management already implemented
- AuthHandlers.h/cpp provides three static methods:
  - handleStatus(): GET /api/v1/auth/status (public) - returns {enabled: true, keyConfigured: bool}
  - handleRotate(): POST /api/v1/auth/rotate (requires auth) - generates new key, returns it
  - handleClear(): DELETE /api/v1/auth/key (requires auth) - clears NVS, reverts to default
- V1ApiRoutes.cpp registers routes with proper auth checks (lines 1450-1473)
- Files: firmware/v2/src/network/webserver/handlers/AuthHandlers.h, AuthHandlers.cpp
- **Learnings for future iterations:**
  - WebServer declares V1ApiRoutes as friend class to allow access to m_apiKeyManager
  - sendSuccessResponse() helper auto-wraps data in standard API response
  - sendErrorResponse() helper with ErrorCodes:: enum for consistent error handling
  - Public endpoints skip checkAPIKey() call, auth endpoints include it before handler
---

## 2025-01-24 - US-005
- Created AuthRateLimiter class for brute force protection
- New file: firmware/v2/src/network/webserver/AuthRateLimiter.h (header-only, follows RateLimiter pattern)
- Configuration: 5 failed attempts / 60 seconds triggers 5-minute block
- Integrated into WebServer checkAPIKey() for REST endpoints
- Integrated into WsGateway auth lambda for WebSocket connections
- Added sendAuthRateLimitError() and buildWsAuthRateLimitError() helpers to ApiResponse.h
- Files changed: WebServer.h, WebServer.cpp, ApiResponse.h, AuthRateLimiter.h
- **Learnings for future iterations:**
  - AuthRateLimiter follows same ITimeSource pattern as RateLimiter for testability
  - Entry struct: {ip, windowStart, failureCount, blockedUntil} ~24 bytes each
  - LRU eviction when tracking table full (8 IPs max)
  - recordFailure() returns bool to indicate if threshold just exceeded
  - recordSuccess() resets failure count but doesn't clear block (wait until expiry)
  - Both REST and WebSocket share same m_authRateLimiter instance
  - Use FEATURE_WEB_SERVER && FEATURE_API_AUTH guards for conditional compilation
---

## 2025-01-24 - US-006
- Created WebSocket auth commands for key management
- WsAuthCommands.h/cpp in src/network/webserver/ws/
- auth.status: Returns {enabled: true, keyConfigured: bool} (public command)
- auth.rotate: Generates new key and returns it (requires authenticated client)
- Added WebServer::isClientAuthenticated() to check if WS client is authenticated
- Added WebServer::getApiKeyManager() to access ApiKeyManager from WS commands
- Registered commands in WebServer::setupWebSocket() with FEATURE_API_AUTH guards
- Files changed: WebServer.h, WebServer.cpp, WsAuthCommands.h, WsAuthCommands.cpp
- **Learnings for future iterations:**
  - WebSocket command handlers receive WebServerContext& ctx
  - ctx.server->isClientAuthenticated(client->id()) checks auth status
  - ctx.server->getApiKeyManager() provides access to ApiKeyManager
  - buildWsResponse() and buildWsError() from ApiResponse.h for WS responses
  - All WS auth commands guarded by #if FEATURE_WEB_SERVER && FEATURE_API_AUTH
  - Handler pattern: static void handler(AsyncWebSocketClient*, JsonDocument&, const WebServerContext&)
---

## 2025-01-24 - US-007
- Added Security section to web dashboard for authentication management
- index.html: Added Security card after Color Correction section with:
  - Auth status badges (Authentication: Enabled/Disabled, Custom Key: Yes/Default)
  - API key input field with show/hide toggle button
  - Save Key and Clear buttons for key management
  - Rotate API Key button (gold, prominent styling)
  - New key display container with copy-to-clipboard functionality
- app.js: Added complete authentication state management:
  - state.auth object: {enabled, keyConfigured, authenticated, apiKey}
  - loadAuthKey(): Loads API key from localStorage('lightwaveApiKey')
  - saveAuthKey(): Saves API key to localStorage
  - clearAuthKey(): Clears stored API key
  - fetchAuthStatus(): Sends auth.status WebSocket command
  - authenticateWithDevice(): Sends auth message with stored key
  - rotateApiKey(): Sends auth.rotate WebSocket command
  - handleAuthStatusResponse(), handleAuthResponse(), handleAuthRotateResponse(): Message handlers
  - updateAuthUI(): Updates UI based on auth state
- WebSocket integration:
  - fetchAuthStatus() called on connection (after 100ms delay)
  - Auto-authenticate when auth.status response indicates auth enabled and key available
  - Reset auth.authenticated on disconnect
- Files changed: firmware/v2/data/index.html, firmware/v2/data/app.js
- **Learnings for future iterations:**
  - localStorage keys: 'lightwaveHost' (device IP), 'lightwaveApiKey' (API key)
  - Auth flow: connect → auth.status → if enabled && key stored → auth message → authenticated
  - UI pattern: Show key input when not authenticated, show management when authenticated
  - Copy to clipboard uses navigator.clipboard.writeText() with visual feedback
  - Always reset auth.authenticated on WebSocket disconnect (needs re-auth on reconnect)
---

## 2025-01-24 - US-008
- Added comprehensive Authentication documentation to docs/api/api-v1.md
- Updated Table of Contents with Authentication section (section 5)
- Added sections:
  - Enabling Authentication: Build flags and default key
  - REST API Authentication: X-API-Key header format, public vs protected endpoints
  - WebSocket Authentication: Connection flow and session management
  - Key Management Endpoints: auth/status, auth/rotate, auth/key with cURL examples
  - Authentication Rate Limiting: 5 attempts/60s window, 5-minute block
  - WebSocket Authentication Commands: auth.status, auth, auth.rotate with JS examples
- Updated documentation version to 1.2.0, date to 2026-01-24
- Files changed: docs/api/api-v1.md
- **Learnings for future iterations:**
  - API documentation lives in docs/api/api-v1.md (not firmware/v2/docs/)
  - Table of Contents numbering must be updated when adding sections
  - WebSocket command sections group related commands together
  - Documentation should include both REST and WebSocket equivalents
  - Version/date footer at bottom of api-v1.md tracks documentation changes
---

