<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context Pack Telemetry Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #fff;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: #2a2a3e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
        }
        .stat-card h3 {
            color: #6c9;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .chart-container {
            background: #2a2a3e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .chart-container h3 {
            color: #6c9;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #2a2a3e;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        th {
            background: #3a3a4e;
            color: #6c9;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        td {
            padding: 12px;
            border-top: 1px solid #333;
            font-size: 14px;
        }
        tr:hover {
            background: #3a3a4e;
        }
        .cache-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .cache-good {
            background: #6c9;
        }
        .cache-medium {
            background: #fc9;
        }
        .cache-poor {
            background: #c66;
        }
        .error {
            color: #c66;
            padding: 20px;
            background: #3a2a2a;
            border: 1px solid #633;
            border-radius: 8px;
            margin: 20px 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Context Pack Telemetry Dashboard</h1>
        <p class="subtitle">Token savings, cache-hit indicators, and performance metrics</p>
        
        <div id="loading" class="loading">Loading pack stats...</div>
        <div id="error" style="display: none;"></div>
        <div id="dashboard" style="display: none;">
            <!-- Stats Grid -->
            <div class="stats-grid" id="stats-grid"></div>
            
            <!-- Charts -->
            <div class="chart-container">
                <h3>Token Savings</h3>
                <canvas id="savings-chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Cache-Hit Friendliness</h3>
                <canvas id="cache-chart"></canvas>
            </div>
            
            <!-- Domain Classifications Table -->
            <div id="domain-section" style="display: none;">
                <h3 style="color: #6c9; margin-bottom: 20px;">Domain Classifications</h3>
                <table id="domain-table">
                    <thead>
                        <tr>
                            <th>Domain</th>
                            <th>Files</th>
                            <th>Agent</th>
                        </tr>
                    </thead>
                    <tbody id="domain-tbody"></tbody>
                </table>
            </div>
            
            <!-- Protected Files Table -->
            <div id="protected-section" style="display: none; margin-top: 30px;">
                <h3 style="color: #c66; margin-bottom: 20px;">Protected Files</h3>
                <table id="protected-table">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>Level</th>
                            <th>Checks</th>
                        </tr>
                    </thead>
                    <tbody id="protected-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Load pack_stats.json from current directory or parent directory
        async function loadStats() {
            const currentDir = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
            const possiblePaths = [
                './pack_stats.json',
                '../pack_stats.json',
                './contextpack/pack_stats.json',
            ];
            
            let stats = null;
            for (const path of possiblePaths) {
                try {
                    const response = await fetch(path);
                    if (response.ok) {
                        stats = await response.json();
                        break;
                    }
                } catch (e) {
                    continue;
                }
            }
            
            if (!stats) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = 
                    '<div class="error">Error: pack_stats.json not found. Please generate a context pack first.</div>';
                return;
            }
            
            renderDashboard(stats);
        }
        
        function renderDashboard(stats) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Render stat cards
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Diff Size</h3>
                    <div class="stat-value">${(stats.diff_size / 1024).toFixed(1)} KB</div>
                    <div class="stat-label">${stats.diff_files} files, ${stats.diff_parts} part(s)</div>
                </div>
                <div class="stat-card">
                    <h3>Token Savings</h3>
                    <div class="stat-value">${stats.token_savings_percent || 0}%</div>
                    <div class="stat-label">${stats.fixtures_converted || 0} fixtures converted</div>
                </div>
                <div class="stat-card">
                    <h3>Estimated Tokens</h3>
                    <div class="stat-value">${(stats.estimated_prompt_tokens || 0).toLocaleString()}</div>
                    <div class="stat-label">Prompt tokens (estimate)</div>
                </div>
                <div class="stat-card">
                    <h3>Cache Stability</h3>
                    <div class="stat-value">
                        <span class="cache-indicator ${getCacheIndicatorClass(stats.cache_fingerprint)}"></span>
                        ${getCacheStabilityText(stats.cache_fingerprint)}
                    </div>
                    <div class="stat-label">Stable prefix tokens</div>
                </div>
            `;
            
            // Render savings chart
            if (stats.fixtures_converted > 0) {
                const savingsCtx = document.getElementById('savings-chart').getContext('2d');
                new Chart(savingsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['TOON Savings', 'Remaining'],
                        datasets: [{
                            data: [stats.token_savings_percent || 0, 100 - (stats.token_savings_percent || 0)],
                            backgroundColor: ['#6c9', '#333'],
                        }],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#eee' } },
                        },
                    },
                });
            }
            
            // Render cache chart
            if (stats.cache_fingerprint && stats.cache_fingerprint.stable_prefix_tokens) {
                const cacheCtx = document.getElementById('cache-chart').getContext('2d');
                const tokens = stats.cache_fingerprint.stable_prefix_tokens;
                const cacheTarget = 1024;
                new Chart(cacheCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Stable Prefix Tokens'],
                        datasets: [{
                            label: 'Tokens',
                            data: [tokens],
                            backgroundColor: tokens >= cacheTarget ? '#6c9' : (tokens >= cacheTarget * 0.8 ? '#fc9' : '#c66'),
                        }],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#eee' },
                                grid: { color: '#333' },
                            },
                            x: {
                                ticks: { color: '#eee' },
                                grid: { color: '#333' },
                            },
                        },
                        plugins: {
                            legend: { display: false },
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: cacheTarget,
                                        yMax: cacheTarget,
                                        borderColor: '#6c9',
                                        borderWidth: 2,
                                        label: { content: 'Target (1024)', enabled: true },
                                    },
                                },
                            },
                        },
                    },
                });
            }
            
            // Render domain classifications
            if (stats.domain_classifications && Object.keys(stats.domain_classifications).length > 0) {
                document.getElementById('domain-section').style.display = 'block';
                const tbody = document.getElementById('domain-tbody');
                tbody.innerHTML = '';
                for (const [domain, count] of Object.entries(stats.domain_classifications)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${domain.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                        <td>${count}</td>
                        <td>${getAgentForDomain(domain)}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Render protected files
            if (stats.protected_files_detected && stats.protected_files_detected.length > 0) {
                document.getElementById('protected-section').style.display = 'block';
                const tbody = document.getElementById('protected-tbody');
                tbody.innerHTML = '';
                for (const file of stats.protected_files_detected) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${file}</td>
                        <td><span style="color: #c66;">CRITICAL</span></td>
                        <td>Protected file protocols</td>
                    `;
                    tbody.appendChild(row);
                }
            }
        }
        
        function getCacheIndicatorClass(fingerprint) {
            if (!fingerprint || !fingerprint.stable_prefix_tokens) return 'cache-poor';
            const tokens = fingerprint.stable_prefix_tokens;
            if (tokens >= 1024) return 'cache-good';
            if (tokens >= 800) return 'cache-medium';
            return 'cache-poor';
        }
        
        function getCacheStabilityText(fingerprint) {
            if (!fingerprint || !fingerprint.stable_prefix_tokens) return 'Unknown';
            const tokens = fingerprint.stable_prefix_tokens;
            if (tokens >= 1024) return 'Good';
            if (tokens >= 800) return 'Medium';
            return 'Poor';
        }
        
        function getAgentForDomain(domain) {
            const agents = {
                'firmware_effects': 'embedded',
                'network_api': 'api',
                'dashboard_ui': 'frontend',
                'documentation': 'documentation',
            };
            return agents[domain] || 'unknown';
        }
        
        // Load stats on page load
        loadStats();
    </script>
</body>
</html>
