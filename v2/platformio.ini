; PlatformIO Configuration for LightwaveOS v2
;
; Next-gen platform architecture with:
; - Actor model for cross-core communication
; - Plugin system with IEffect interface
; - CQRS state management
; - Multi-device synchronization
;
; Build commands:
;   pio run                    # Default build
;   pio run -e esp32dev_wifi   # With WiFi/WebSocket
;   pio run -e native_test     # Unit tests on host
;
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = esp32dev
description = LightwaveOS v2 - Next-Gen LED Control Platform

[env:esp32dev]
platform = espressif32@6.9.0
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
; 460800 is fast but can be unreliable for large LittleFS images over USB CDC.
; Use a conservative baud rate to avoid serial corruption during uploadfs.
upload_speed = 115200
board_build.f_cpu = 240000000L
board_build.flash_mode = dio
board_build.filesystem = littlefs
board_build.arduino.memory_type = qio_opi
board_upload.flash_size = 8MB
build_unflags = -std=gnu++11
build_flags =
	-std=gnu++17
	-Werror=deprecated-declarations
	-O3
	-ffast-math
	-funroll-loops
	-D ARDUINO_USB_MODE=1
	-D ARDUINO_USB_CDC_ON_BOOT=1
	-D CONFIG_TINYUSB_CDC_ENABLED=1
	-D DISABLE_ALL_LIBRARY_WARNINGS
	-D CORE_DEBUG_LEVEL=2
	-D CONFIG_ASYNC_TCP_RUNNING_CORE=1
	-D CONFIG_ASYNC_TCP_USE_WDT=0
	-D FASTLED_RMT_BUILTIN_DRIVER=1
	-D FASTLED_ALLOW_INTERRUPTS=0
	-D FASTLED_ESP32_FLASH_LOCK=0
	-D FASTLED_INTERRUPT_RETRY_COUNT=0
	-D CONFIG_FREERTOS_ASSERT_FAIL_ABORT=1
	-D configASSERT_DEFINED=1
	; v2 feature flags
	-D LIGHTWAVEOS_V2=1
	-D FEATURE_ACTOR_SYSTEM=1
	-D FEATURE_PLUGIN_RUNTIME=1
	-D FEATURE_CQRS_STATE=1
	-D FEATURE_HAL_ABSTRACTION=1
	; Network features
	-D FEATURE_WEB_SERVER=1
lib_ldf_mode = deep+
lib_deps =
	fastled/FastLED@3.10.0
	bblanchon/ArduinoJson@7.0.4
	esp32async/ESPAsyncWebServer@^3.6.0
	esp32async/AsyncTCP@^3.4.4
; Sync subsystem uses ESP-IDF native esp_websocket_client (no external library needed)
build_src_filter = +<*>

[env:esp32dev_wifi]
extends = env:esp32dev
build_flags =
	${env:esp32dev.build_flags}
	-D FEATURE_WEB_SERVER=1
	-D FEATURE_MULTI_DEVICE=1

[env:debug]
extends = env:esp32dev
build_type = debug
build_flags =
	${env:esp32dev.build_flags}
	-D DEBUG=1
	-D CORE_DEBUG_LEVEL=5

; Audio-reactive build with SPH0645 I2S microphone
; Build: pio run -e esp32dev_audio
[env:esp32dev_audio]
extends = env:esp32dev_wifi
build_flags =
	${env:esp32dev_wifi.build_flags}
	-D FEATURE_AUDIO_SYNC=1
	-D CORE_DEBUG_LEVEL=3

; Native unit tests (no hardware required)
; Build: pio run -e native_test
; Run:   .pio/build/native_test/program
[env:native_test]
platform = native
build_src_filter =
	-<*>
	+<../test/test_native/*>
build_flags =
	-std=c++17
	-D NATIVE_BUILD=1
	-D LIGHTWAVEOS_V2=1
	-D NUM_LEDS=320
	-D CENTER_POINT=80
	-D FEATURE_MULTI_DEVICE=1
	-I test/test_native
	-I test/test_native/mocks
	-I src
	-I src/sync
test_framework = unity
test_build_src = no
lib_deps =
	throwtheswitch/Unity@^2.5.2
